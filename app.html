<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WildGuard AI - Enhanced Autonomous Wildlife Surveillance</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0a1a2a 0%, #1a2a3a 100%);
            color: #ffffff;
            overflow-x: hidden;
        }

        .header {
            background: rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
            padding: 1rem 2rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            position: fixed;
            width: 100%;
            top: 0;
            z-index: 1000;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1400px;
            margin: 0 auto;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: bold;
            color: #00ff88;
        }

        .system-status {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #00ff88;
            animation: pulse 2s infinite;
        }

        .offline-indicator {
            background: #ff4444 !important;
        }

        .main-container {
            margin-top: 80px;
            padding: 2rem;
            max-width: 1600px;
            margin-left: auto;
            margin-right: auto;
        }

        .control-panel {
            display: grid;
            grid-template-columns: 1fr 2fr 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .panel {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 1.5rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .panel-title {
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 1rem;
            color: #00ff88;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .mission-controls {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .control-group label {
            font-size: 0.9rem;
            color: #cccccc;
        }

        .control-input {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 5px;
            padding: 0.5rem;
            color: white;
            font-size: 0.9rem;
        }

        .control-input:focus {
            outline: none;
            border-color: #00ff88;
        }

        .btn {
            background: linear-gradient(45deg, #00ff88, #00ccff);
            color: #000;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 25px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            margin-top: 0.5rem;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 255, 136, 0.3);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn-danger {
            background: linear-gradient(45deg, #ff4444, #ff6666);
            color: white;
        }

        .btn-secondary {
            background: linear-gradient(45deg, #666, #888);
            color: white;
        }

        .map-container {
            position: relative;
            height: 400px;
            border-radius: 15px;
            overflow: hidden;
            border: 2px solid rgba(255, 255, 255, 0.1);
        }

        #realMap {
            height: 100%;
            width: 100%;
            border-radius: 13px;
        }

        .location-search {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            display: flex;
            gap: 0.5rem;
        }

        .search-input {
            background: rgba(0, 0, 0, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 25px;
            font-size: 0.9rem;
            width: 300px;
        }

        .search-btn {
            background: #00ff88;
            border: none;
            color: #000;
            padding: 0.5rem 1rem;
            border-radius: 25px;
            cursor: pointer;
            font-weight: bold;
        }

        .drone-marker {
            background: #00ff88;
            border: 3px solid #fff;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            box-shadow: 0 0 20px #00ff88, 0 0 40px rgba(0, 255, 136, 0.5);
            animation: dronePatrol 2s ease-in-out infinite;
        }

        .drone-icon {
            font-size: 16px;
            position: absolute;
            top: -2px;
            left: -2px;
        }

        .waypoint-marker {
            background: #ffff00;
            border: 2px solid #fff;
            border-radius: 50%;
            width: 12px;
            height: 12px;
            animation: waypointPulse 2s ease-in-out infinite;
        }

        .detection-marker {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            animation: markerPulse 2s ease-in-out infinite;
        }

        .animal-marker {
            background: #ffff00;
            box-shadow: 0 0 10px #ffff00;
        }

        .threat-marker {
            background: #ff4444;
            box-shadow: 0 0 10px #ff4444;
            animation: threatAlert 1s ease-in-out infinite;
        }

        .environmental-marker {
            background: #00ccff;
            box-shadow: 0 0 10px #00ccff;
        }

        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }

        .status-card {
            background: rgba(255, 255, 255, 0.1);
            padding: 1rem;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            text-align: center;
        }

        .status-label {
            font-size: 0.8rem;
            color: #cccccc;
            margin-bottom: 0.5rem;
        }

        .status-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #00ff88;
        }

        .expanded-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-top: 2rem;
        }

        .live-feed-container {
            position: relative;
            background: rgba(0, 0, 0, 0.8);
            border-radius: 15px;
            overflow: hidden;
            aspect-ratio: 16/9;
            border: 2px solid rgba(255, 255, 255, 0.1);
        }

        .video-feed {
            width: 100%;
            height: 100%;
            background: linear-gradient(45deg, #1a1a1a 25%, transparent 25%), 
                        linear-gradient(-45deg, #1a1a1a 25%, transparent 25%), 
                        linear-gradient(45deg, transparent 75%, #1a1a1a 75%), 
                        linear-gradient(-45deg, transparent 75%, #1a1a1a 75%);
            background-size: 20px 20px;
            background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .video-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, rgba(0,255,136,0.1), rgba(0,204,255,0.1));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            color: #00ff88;
        }

        .video-controls {
            position: absolute;
            bottom: 1rem;
            left: 1rem;
            right: 1rem;
            display: flex;
            gap: 0.5rem;
            background: rgba(0, 0, 0, 0.7);
            padding: 0.5rem;
            border-radius: 10px;
        }

        .video-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 0.5rem;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .video-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .video-btn.recording {
            background: #ff4444;
            animation: recordingPulse 2s ease-in-out infinite;
        }

        .ai-analysis {
            margin-top: 2rem;
        }

        .analysis-tabs {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        .tab {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 25px;
            padding: 0.5rem 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }

        .tab.active {
            background: #00ff88;
            color: #000;
        }

        .analysis-content {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 1.5rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .detection-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .detection-item {
            background: rgba(255, 255, 255, 0.1);
            margin: 0.5rem 0;
            padding: 1rem;
            border-radius: 10px;
            border-left: 4px solid #00ff88;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .detection-item.threat {
            border-left-color: #ff4444;
            animation: threatFlash 2s ease-in-out infinite;
        }

        .detection-info {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .detection-species {
            font-weight: bold;
            color: #00ff88;
        }

        .detection-details {
            font-size: 0.8rem;
            color: #cccccc;
        }

        .confidence-bar {
            width: 60px;
            height: 4px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 2px;
            overflow: hidden;
        }

        .confidence-fill {
            height: 100%;
            background: linear-gradient(45deg, #00ff88, #00ccff);
            transition: width 0.3s ease;
        }

        .data-management {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1rem;
        }

        .data-card {
            background: rgba(255, 255, 255, 0.1);
            padding: 1.5rem;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .download-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .comparison-chart {
            background: rgba(255, 255, 255, 0.1);
            height: 200px;
            border-radius: 10px;
            display: flex;
            align-items: end;
            justify-content: space-around;
            padding: 1rem;
            margin-top: 1rem;
        }

        .chart-bar {
            background: linear-gradient(45deg, #00ff88, #00ccff);
            width: 30px;
            border-radius: 3px;
            position: relative;
            animation: chartGrow 1s ease-out;
        }

        .chart-label {
            position: absolute;
            bottom: -25px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.7rem;
            color: #cccccc;
        }

        .chart-value {
            position: absolute;
            top: -20px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.7rem;
            color: #00ff88;
        }

        .environmental-data {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
        }

        .env-metric {
            background: rgba(255, 255, 255, 0.1);
            padding: 1rem;
            border-radius: 10px;
            text-align: center;
        }

        .env-value {
            font-size: 1.8rem;
            font-weight: bold;
            color: #00ccff;
        }

        .env-label {
            font-size: 0.8rem;
            color: #cccccc;
            margin-top: 0.5rem;
        }

        .env-trend {
            font-size: 0.7rem;
            margin-top: 0.25rem;
        }

        .trend-up { color: #00ff88; }
        .trend-down { color: #ff4444; }
        .trend-stable { color: #ffff00; }

        .alert-panel {
            position: fixed;
            top: 100px;
            right: 2rem;
            width: 350px;
            max-height: 400px;
            overflow-y: auto;
            z-index: 1000;
        }

        .alert-item {
            background: rgba(255, 68, 68, 0.9);
            backdrop-filter: blur(10px);
            margin: 0.5rem 0;
            padding: 1rem;
            border-radius: 10px;
            border: 1px solid #ff4444;
            animation: alertSlideIn 0.5s ease-out;
        }

        .alert-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .alert-title {
            font-weight: bold;
            color: white;
        }

        .alert-time {
            font-size: 0.8rem;
            color: #ffcccc;
        }

        .alert-details {
            font-size: 0.9rem;
            color: white;
        }

        .close-alert {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            font-size: 1.2rem;
        }

        .route-info {
            background: rgba(255, 255, 255, 0.1);
            padding: 1rem;
            border-radius: 10px;
            margin-top: 1rem;
        }

        .media-gallery {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .media-item {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            overflow: hidden;
            aspect-ratio: 16/9;
            position: relative;
            cursor: pointer;
            transition: transform 0.3s ease;
        }

        .media-item:hover {
            transform: scale(1.05);
        }

        .media-thumbnail {
            width: 100%;
            height: 100%;
            background: linear-gradient(45deg, #333, #555);
            display: flex;
            align-items: center;
            justify-content: center;
            color: #ccc;
            font-size: 2rem;
        }

        .media-info {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.8);
            padding: 0.5rem;
            font-size: 0.8rem;
        }

        .map-info-panel {
            position: absolute;
            top: 60px;
            left: 10px;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            padding: 1rem;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            z-index: 1000;
            min-width: 250px;
            font-size: 0.9rem;
        }

        .map-info-item {
            display: flex;
            justify-content: space-between;
            margin: 0.25rem 0;
            padding: 0.25rem 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .map-info-item:last-child {
            border-bottom: none;
        }

        .map-info-label {
            color: #cccccc;
            font-weight: 500;
        }

        .map-info-value {
            color: #00ff88;
            font-weight: bold;
        }

        .map-controls {
            position: absolute;
            top: 60px;
            right: 10px;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            z-index: 1000;
        }

        .map-control-btn {
            background: rgba(0, 0, 0, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            padding: 0.5rem;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.3s ease;
        }

        .map-control-btn:hover {
            background: rgba(0, 255, 136, 0.3);
            border-color: #00ff88;
        }

        .map-control-btn.active {
            background: #00ff88;
            color: #000;
        }

        .drone-connection-panel {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .connection-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .offline-mode-panel {
            background: rgba(255, 170, 0, 0.1);
            border: 1px solid #ffaa00;
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .species-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 1rem;
            margin: 0.5rem 0;
            border-left: 4px solid;
        }

        .species-card.endangered { border-left-color: #ff4444; }
        .species-card.vulnerable { border-left-color: #ffaa00; }
        .species-card.stable { border-left-color: #00ff88; }

        .behavior-pattern {
            background: rgba(0, 204, 255, 0.1);
            border-radius: 8px;
            padding: 0.8rem;
            margin: 0.5rem 0;
        }

        .weather-widget {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 1rem;
            margin: 1rem 0;
        }

        .drone-fleet-status {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin: 1rem 0;
        }

        .drone-status {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 1rem;
            text-align: center;
        }

        .risk-heatmap {
            background: rgba(255, 68, 68, 0.1);
            border-radius: 10px;
            padding: 1rem;
            margin: 1rem 0;
        }

        .evidence-log {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 1rem;
            max-height: 200px;
            overflow-y: auto;
        }

        .satellite-status {
            background: rgba(0, 255, 136, 0.1);
            border-radius: 8px;
            padding: 0.8rem;
            margin: 0.5rem 0;
        }

        @keyframes dronePatrol {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        @keyframes waypointPulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.3); opacity: 0.7; }
        }

        @keyframes markerPulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.2); opacity: 0.7; }
        }

        @keyframes threatAlert {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.4); }
        }

        @keyframes threatFlash {
            0%, 100% { background: rgba(255, 255, 255, 0.1); }
            50% { background: rgba(255, 68, 68, 0.2); }
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        @keyframes alertSlideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes recordingPulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        @keyframes chartGrow {
            from { height: 0; }
            to { height: var(--chart-height); }
        }

        @media (max-width: 1200px) {
            .control-panel {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
            
            .expanded-section {
                grid-template-columns: 1fr;
            }
            
            .alert-panel {
                position: relative;
                top: auto;
                right: auto;
                width: 100%;
                margin-top: 2rem;
            }
        }

        @media (max-width: 768px) {
            .main-container {
                padding: 1rem;
            }
            
            .header-content {
                flex-direction: column;
                gap: 1rem;
            }
            
            .system-status {
                flex-wrap: wrap;
            }
            
            .analysis-tabs {
                overflow-x: auto;
                white-space: nowrap;
            }
            
            .map-info-panel {
                position: relative;
                top: auto;
                left: auto;
                margin-top: 1rem;
            }

            .location-search {
                position: relative;
                top: auto;
                left: auto;
                transform: none;
                margin-bottom: 1rem;
            }

            .search-input {
                width: 200px;
            }
        }

        .leaflet-popup-content-wrapper {
            background: rgba(0, 0, 0, 0.9);
            color: white;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .leaflet-popup-content {
            margin: 1rem;
            line-height: 1.4;
        }

        .leaflet-popup-tip {
            background: rgba(0, 0, 0, 0.9);
        }
    </style>
</head>
<body>
    <!-- System Header -->
    <header class="header">
        <div class="header-content">
            <div class="logo">üåø WildGuard AI - Enhanced Conservation System</div>
            <div class="system-status">
                <div class="status-item">
                    <div class="status-dot" id="systemDot"></div>
                    <span id="systemStatus">System Online</span>
                </div>
                <div class="status-item">
                    <div class="status-dot" id="aiDot"></div>
                    <span>AI Active</span>
                </div>
                <div class="status-item">
                    <div class="status-dot" id="droneDot"></div>
                    <span id="droneStatus">Drone Connected</span>
                </div>
                <div class="status-item">
                    <div class="status-dot" id="feedDot"></div>
                    <span>Live Feed Active</span>
                </div>
                <div class="status-item">
                    <span id="systemTime">00:00:00</span>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Control Interface -->
    <main class="main-container">
        <div class="control-panel">
            <!-- Mission Control Panel -->
            <div class="panel">
                <h2 class="panel-title">üéØ Mission Control</h2>
                
                <!-- Drone Connection Panel -->
                <div class="drone-connection-panel">
                    <div class="connection-status">
                        <div class="status-dot" id="connectionDot"></div>
                        <span id="connectionStatus">Searching for drones...</span>
                    </div>
                    <div class="control-group">
                        <label>Drone Protocol</label>
                        <select class="control-input" id="droneProtocol">
                            <option value="mavlink">MAVLink (ArduPilot/PX4)</option>
                            <option value="dji">DJI SDK</option>
                            <option value="parrot">Parrot Ground SDK</option>
                            <option value="yuneec">Yuneec SDK</option>
                            <option value="custom">Custom Protocol</option>
                            <option value="simulator">Simulator Mode</option>
                        </select>
                    </div>
                    <div class="control-group">
                        <label>Connection Method</label>
                        <select class="control-input" id="connectionMethod">
                            <option value="wifi">WiFi Direct</option>
                            <option value="bluetooth">Bluetooth</option>
                            <option value="radio">Radio Controller</option>
                            <option value="cellular">Cellular/4G/5G</option>
                            <option value="satellite">Satellite Link</option>
                        </select>
                    </div>
                    <button class="btn" id="connectDrone">Connect Drone</button>
                </div>

                <!-- Offline Mode Panel -->
                <div class="offline-mode-panel" id="offlinePanel" style="display: none;">
                    <h4>üîÑ Offline Mode Active</h4>
                    <p>üì° Network connectivity lost. System operating in offline mode.</p>
                    <p>‚úÖ Local data cache active | ‚úÖ Offline maps loaded | ‚úÖ AI models cached</p>
                    <p>üîÑ Data will sync when connection restored</p>
                </div>

                <div class="mission-controls">
                    <div class="control-group">
                        <label>Mission Type</label>
                        <select class="control-input" id="missionType">
                            <option value="patrol">Standard Patrol</option>
                            <option value="survey">Wildlife Survey</option>
                            <option value="threat">Threat Response</option>
                            <option value="environmental">Environmental Monitoring</option>
                            <option value="custom">Custom Route</option>
                            <option value="swarm">Drone Swarm Coordination</option>
                        </select>
                    </div>
                    <div class="control-group">
                        <label>Flight Altitude (meters)</label>
                        <input type="range" class="control-input" id="altitude" min="50" max="400" value="150">
                        <span id="altitudeValue">150m</span>
                    </div>
                    <div class="control-group">
                        <label>Flight Speed (km/h)</label>
                        <input type="range" class="control-input" id="speed" min="10" max="60" value="30">
                        <span id="speedValue">30 km/h</span>
                    </div>
                    <div class="control-group">
                        <label>Mission Duration (hours)</label>
                        <input type="range" class="control-input" id="duration" min="0.5" max="8" step="0.5" value="2">
                        <span id="durationValue">2.0 hours</span>
                    </div>
                    <div class="control-group">
                        <label>Coverage Pattern</label>
                        <select class="control-input" id="pattern">
                            <option value="grid">Grid Survey</option>
                            <option value="perimeter">Perimeter Patrol</option>
                            <option value="random">Random Walk</option>
                            <option value="hotspot">Hotspot Focus</option>
                            <option value="waypoints">Custom Waypoints</option>
                            <option value="ai_optimized">AI-Optimized Route</option>
                        </select>
                    </div>
                    <button class="btn" id="planRoute">Plan Flight Route</button>
                    <button class="btn" id="startMission">Start Autonomous Mission</button>
                    <button class="btn btn-danger" id="emergencyStop">Emergency Stop</button>
                    <button class="btn btn-secondary" id="returnHome">Return to Home</button>
                </div>
            </div>

            <!-- Interactive Real Map Display -->
            <div class="panel">
                <h2 class="panel-title">üó∫Ô∏è Global Wildlife Monitoring Map</h2>
                <div class="map-container">
                    <!-- Location Search -->
                    <div class="location-search">
                        <input type="text" class="search-input" id="locationSearch" placeholder="Search cities, countries, parks...">
                        <button class="search-btn" id="searchLocation">üîç Search</button>
                    </div>
                    
                    <div id="realMap"></div>
                    
                    <!-- Map Info Panel -->
                    <div class="map-info-panel" id="mapInfoPanel">
                        <div class="map-info-item">
                            <span class="map-info-label">Location:</span>
                            <span class="map-info-value" id="currentLocation">Loading...</span>
                        </div>
                        <div class="map-info-item">
                            <span class="map-info-label">Drone Position:</span>
                            <span class="map-info-value" id="droneLocation">Loading...</span>
                        </div>
                        <div class="map-info-item">
                            <span class="map-info-label">Weather:</span>
                            <span class="map-info-value" id="weatherInfo">Loading...</span>
                        </div>
                        <div class="map-info-item">
                            <span class="map-info-label">Coverage Area:</span>
                            <span class="map-info-value" id="coverageArea">0 km¬≤</span>
                        </div>
                        <div class="map-info-item">
                            <span class="map-info-label">Waypoints:</span>
                            <span class="map-info-value" id="waypointCount">0</span>
                        </div>
                        <div class="map-info-item">
                            <span class="map-info-label">Route Distance:</span>
                            <span class="map-info-value" id="routeDistance">0 km</span>
                        </div>
                    </div>

                    <!-- Map Controls -->
                    <div class="map-controls">
                        <button class="map-control-btn" id="addWaypointMode" title="Add Waypoint Mode">üìç Add Points</button>
                        <button class="map-control-btn" id="measureMode" title="Measure Distance">üìè Measure</button>
                        <button class="map-control-btn" id="areaMode" title="Calculate Area">üìê Area</button>
                        <button class="map-control-btn" id="clearMap" title="Clear All Markers">üóëÔ∏è Clear</button>
                        <button class="map-control-btn" id="centerDrone" title="Center on Drone">üéØ Drone</button>
                        <button class="map-control-btn" id="toggleOffline" title="Toggle Offline Mode">üì∂ Online</button>
                    </div>
                </div>
                
                <div class="route-info" id="routeInfo">
                    <strong>Enhanced Global Map:</strong> Search any location worldwide. Offline maps available for remote areas.
                    <br><strong>Location Info:</strong> Click anywhere for detailed location information and wildlife data.
                </div>
            </div>

            <!-- Advanced Analytics Panel -->
            <div class="panel">
                <h2 class="panel-title">ü§ñ AI Analytics & Fleet Status</h2>
                <div class="status-grid">
                    <div class="status-card">
                        <div class="status-label">Animals Detected</div>
                        <div class="status-value" id="animalCount">0</div>
                    </div>
                    <div class="status-card">
                        <div class="status-label">Threats Detected</div>
                        <div class="status-value" id="threatCount">0</div>
                    </div>
                    <div class="status-card">
                        <div class="status-label">Area Covered</div>
                        <div class="status-value" id="areaCovered">0 km¬≤</div>
                    </div>
                    <div class="status-card">
                        <div class="status-label">Species Identified</div>
                        <div class="status-value" id="speciesCount">0</div>
                    </div>
                </div>
                
                <!-- Drone Fleet Status -->
                <div class="drone-fleet-status">
                    <div class="drone-status">
                        <div class="status-value" style="font-size: 1rem;">üöÅ Alpha</div>
                        <div class="status-label">Surveillance</div>
                        <div class="env-trend trend-up" id="droneAlphaStatus">Standby</div>
                    </div>
                    <div class="drone-status">
                        <div class="status-value" style="font-size: 1rem;">üì∏ Beta</div>
                        <div class="status-label">Photography</div>
                        <div class="env-trend trend-up" id="droneBetaStatus">Standby</div>
                    </div>
                    <div class="drone-status">
                        <div class="status-value" style="font-size: 1rem;">üå°Ô∏è Gamma</div>
                        <div class="status-label">Thermal Scan</div>
                        <div class="env-trend trend-up" id="droneGammaStatus">Standby</div>
                    </div>
                </div>

                <div class="control-group" style="margin-top: 1rem;">
                    <label>AI Detection Mode</label>
                    <select class="control-input" id="detectionMode">
                        <option value="all">All Detection (Wildlife + Threats)</option>
                        <option value="wildlife">Wildlife Only</option>
                        <option value="threats">Security Threats Only</option>
                        <option value="environment">Environmental Only</option>
                        <option value="behavior">Behavioral Analysis</option>
                        <option value="species_recognition">Species Recognition</option>
                    </select>
                </div>
                <div class="control-group">
                    <label>Detection Sensitivity</label>
                    <input type="range" class="control-input" id="sensitivity" min="60" max="98" value="85">
                    <span id="sensitivityValue">85% confidence</span>
                </div>
                
                <!-- Wildlife API Integration Status -->
                <div class="satellite-status">
                    <h4>üêæ Wildlife ID API Status</h4>
                    <p><strong>iNaturalist API:</strong> <span style="color: #00ff88;" id="inaturalistStatus">Connected</span></p>
                    <p><strong>eBird API:</strong> <span style="color: #00ff88;" id="ebirdStatus">Connected</span></p>
                    <p><strong>African Wildlife DB:</strong> <span style="color: #00ff88;" id="africaStatus">Connected</span></p>
                    <p><strong>Local Cache:</strong> <span style="color: #00ff88;">50,000+ species</span></p>
                </div>
            </div>
        </div>

        <!-- Live Feed and Advanced Analytics Section -->
        <div class="expanded-section">
            <div class="panel">
                <h2 class="panel-title">üìπ Live Multi-Feed & Audio Analysis</h2>
                <div class="live-feed-container">
                    <div class="video-feed" id="videoFeed">
                        <div class="video-overlay">
                            <span id="feedStatus">üé• DRONE FEED READY</span>
                        </div>
                    </div>
                    <div class="video-controls">
                        <button class="video-btn" id="takePhoto">üì∏ Photo</button>
                        <button class="video-btn" id="recordVideo">üé¨ Record</button>
                        <button class="video-btn" id="toggleThermal">üå°Ô∏è Thermal</button>
                        <button class="video-btn" id="toggleNightVision">üåô Night Vision</button>
                        <button class="video-btn" id="toggleZoom">üîç Zoom</button>
                        <button class="video-btn" id="audioAnalysis">üéµ Audio</button>
                    </div>
                </div>
                
                <!-- Audio Analysis Panel -->
                <div class="behavior-pattern" id="audioPanel" style="display: none;">
                    <h4>üéµ Real-Time Audio Analysis</h4>
                    <div class="environmental-data">
                        <div class="env-metric">
                            <div class="env-value" id="audioLevel">42 dB</div>
                            <div class="env-label">Sound Level</div>
                        </div>
                        <div class="env-metric">
                            <div class="env-value" id="lastSound">Birds Chirping</div>
                            <div class="env-label">Last Detection</div>
                        </div>
                        <div class="env-metric">
                            <div class="env-value" id="threatAudio">None</div>
                            <div class="env-label">Threat Audio</div>
                        </div>
                    </div>
                </div>

                <div class="media-gallery" id="mediaGallery">
                    <!-- Media items will be added here -->
                </div>
            </div>

            <div class="panel">
                <h2 class="panel-title">üå°Ô∏è Environmental & Weather Intelligence</h2>
                <div class="weather-widget">
                    <h4>Real-Time Weather Data</h4>
                    <div class="environmental-data">
                        <div class="env-metric">
                            <div class="env-value" id="temperature">24.3¬∞C</div>
                            <div class="env-label">Temperature</div>
                            <div class="env-trend trend-up">‚Üó +0.5¬∞C</div>
                        </div>
                        <div class="env-metric">
                            <div class="env-value" id="humidity">67%</div>
                            <div class="env-label">Humidity</div>
                            <div class="env-trend trend-down">‚Üò -2%</div>
                        </div>
                        <div class="env-metric">
                            <div class="env-value" id="windSpeed">12</div>
                            <div class="env-label">Wind (km/h)</div>
                            <div class="env-trend trend-up">‚Üó +3 km/h</div>
                        </div>
                        <div class="env-metric">
                            <div class="env-value" id="visibility">15km</div>
                            <div class="env-label">Visibility</div>
                            <div class="env-trend trend-stable">‚Üí Clear</div>
                        </div>
                        <div class="env-metric">
                            <div class="env-value" id="uvIndex">6</div>
                            <div class="env-label">UV Index</div>
                            <div class="env-trend trend-up">High</div>
                        </div>
                        <div class="env-metric">
                            <div class="env-value" id="airQuality">Good</div>
                            <div class="env-label">Air Quality</div>
                            <div class="env-trend trend-stable">‚Üí PM2.5: 15</div>
                        </div>
                    </div>
                </div>

                <!-- Risk Assessment -->
                <div class="risk-heatmap">
                    <h4>üî• Threat Risk Assessment</h4>
                    <div class="environmental-data">
                        <div class="env-metric">
                            <div class="env-value" style="color: #ffaa00;">Medium</div>
                            <div class="env-label">Poaching Risk</div>
                            <div class="env-trend trend-down">‚Üò -15%</div>
                        </div>
                        <div class="env-metric">
                            <div class="env-value" style="color: #00ff88;">Low</div>
                            <div class="env-label">Fire Risk</div>
                            <div class="env-trend trend-stable">‚Üí Stable</div>
                        </div>
                        <div class="env-metric">
                            <div class="env-value" style="color: #ff4444;">High</div>
                            <div class="env-label">Illegal Activity</div>
                            <div class="env-trend trend-up">‚Üó Alert</div>
                        </div>
                    </div>
                </div>

                <!-- Satellite Communication Status -->
                <div class="satellite-status">
                    <h4>üõ∞Ô∏è Communication Status</h4>
                    <p><strong>Connection:</strong> <span style="color: #00ff88;" id="commStatus">Satellite Link Active</span></p>
                    <p><strong>Signal Strength:</strong> <span style="color: #00ff88;" id="signalStrength">Excellent (98%)</span></p>
                    <p><strong>Range:</strong> <span style="color: #00ff88;" id="droneRange">15.2 km</span></p>
                    <p><strong>Latency:</strong> <span id="latency">28ms</span></p>
                </div>
            </div>
        </div>

        <!-- Enhanced AI Analysis Section -->
        <div class="ai-analysis">
            <div class="analysis-tabs">
                <div class="tab active" data-tab="species">Species Recognition</div>
                <div class="tab" data-tab="behavior">Behavioral Analysis</div>
                <div class="tab" data-tab="detections">Real-Time Detections</div>
                <div class="tab" data-tab="environment">Habitat Monitoring</div>
                <div class="tab" data-tab="threats">Threat Intelligence</div>
                <div class="tab" data-tab="evidence">Evidence Collection</div>
                <div class="tab" data-tab="predictions">Predictive Analytics</div>
                <div class="tab" data-tab="network">Conservation Network</div>
            </div>

            <div class="analysis-content">
                <!-- Species Recognition -->
                <div id="species-content" class="tab-content">
                    <h3>ü¶Å Advanced Species Recognition & Conservation Status</h3>
                    <div class="detection-list" id="speciesList">
                        <div class="species-card endangered">
                            <div class="detection-info">
                                <div class="detection-species">African Elephant (Loxodonta africana)</div>
                                <div class="detection-details">
                                    Status: Endangered ‚Ä¢ Confidence: 96% ‚Ä¢ Count: 3 individuals
                                    <br>Last seen: Migration corridor, 2.3km NE ‚Ä¢ Behavior: Foraging
                                    <br>Conservation Priority: Critical ‚Ä¢ Population trend: ‚Üò Declining
                                    <br>API Source: iNaturalist + African Wildlife Database
                                </div>
                            </div>
                            <div class="confidence-bar">
                                <div class="confidence-fill" style="width: 96%"></div>
                            </div>
                        </div>
                        <div class="species-card vulnerable">
                            <div class="detection-info">
                                <div class="detection-species">African Lion (Panthera leo)</div>
                                <div class="detection-details">
                                    Status: Vulnerable ‚Ä¢ Confidence: 92% ‚Ä¢ Count: 2 individuals (pride)
                                    <br>Last seen: Savanna area, 1.8km SW ‚Ä¢ Behavior: Resting
                                    <br>Conservation Priority: High ‚Ä¢ Population trend: ‚Üí Stable
                                    <br>API Source: CITES Database + Local Cache
                                </div>
                            </div>
                            <div class="confidence-bar">
                                <div class="confidence-fill" style="width: 92%"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Behavioral Analysis -->
                <div id="behavior-content" class="tab-content" style="display: none;">
                    <h3>üêæ Behavioral Pattern Analysis & Prediction</h3>
                    <div class="behavior-pattern">
                        <h4>Migration Patterns</h4>
                        <p><strong>Current Movement:</strong> Seasonal migration detected - Wildebeest herd moving northwest</p>
                        <p><strong>Pattern Recognition:</strong> Consistent with historical data from past 5 years</p>
                        <p><strong>Prediction:</strong> Expected to reach Mara River crossing in 3-4 days</p>
                    </div>
                    <div class="behavior-pattern">
                        <h4>Feeding Behavior Analysis</h4>
                        <p><strong>Grazing Activity:</strong> Peak activity observed 06:00-09:00 and 16:00-19:00</p>
                        <p><strong>Water Source Usage:</strong> High activity near main watering hole (GPS: -1.4023, 35.2341)</p>
                        <p><strong>Territorial Behavior:</strong> Lion pride establishing territory boundaries</p>
                    </div>
                    <div class="behavior-pattern">
                        <h4>Breeding Season Indicators</h4>
                        <p><strong>Mating Calls Detected:</strong> Increased elephant vocalizations in northern sector</p>
                        <p><strong>Nesting Activity:</strong> Bird species showing increased nesting behavior</p>
                        <p><strong>Protective Behavior:</strong> Adult animals showing increased vigilance</p>
                    </div>
                </div>

                <!-- Real-Time Detections -->
                <div id="detections-content" class="tab-content" style="display: none;">
                    <h3>ü§ñ AI Detection Results & Real-Time Monitoring</h3>
                    <div class="detection-list" id="detectionList">
                        <div class="detection-item">
                            <div class="detection-info">
                                <div class="detection-species">System Ready</div>
                                <div class="detection-details">Advanced AI detection systems ready - Wildlife APIs connected</div>
                            </div>
                            <div class="confidence-bar">
                                <div class="confidence-fill" style="width: 100%"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Habitat Monitoring -->
                <div id="environment-content" class="tab-content" style="display: none;">
                    <h3>üåø Habitat Health & Environmental Monitoring</h3>
                    <div class="behavior-pattern">
                        <h4>Vegetation Analysis</h4>
                        <p><strong>Vegetation Index:</strong> NDVI Score: 0.68 (Healthy vegetation)</p>
                        <p><strong>Deforestation Alert:</strong> No significant changes detected in monitored areas</p>
                        <p><strong>Grazing Pressure:</strong> Moderate in sectors A-C, light in sectors D-F</p>
                    </div>
                    <div class="behavior-pattern">
                        <h4>Water Resource Monitoring</h4>
                        <p><strong>Water Levels:</strong> Main river: 2.3m (normal), Lake: 78% capacity</p>
                        <p><strong>Water Quality:</strong> pH 7.2, turbidity low, suitable for wildlife</p>
                        <p><strong>Seasonal Trends:</strong> Water levels expected to decrease 15% this month</p>
                    </div>
                    <div class="behavior-pattern">
                        <h4>Soil & Climate Health</h4>
                        <p><strong>Soil Moisture:</strong> 34% (adequate for current season)</p>
                        <p><strong>Erosion Risk:</strong> Low to moderate in hillside areas</p>
                        <p><strong>Carbon Sequestration:</strong> Forest areas capturing 12.5 tons CO2/hectare/year</p>
                    </div>
                </div>

                <!-- Threat Intelligence -->
                <div id="threats-content" class="tab-content" style="display: none;">
                    <h3>‚ö†Ô∏è Advanced Threat Intelligence & Security</h3>
                    <div class="behavior-pattern">
                        <h4>Poaching Activity Analysis</h4>
                        <p><strong>Risk Level:</strong> <span style="color: #ffaa00;">MEDIUM</span> - Increased activity in eastern sector</p>
                        <p><strong>Pattern Recognition:</strong> Suspicious movement detected during new moon phases</p>
                        <p><strong>Communication Intercepts:</strong> Radio frequency monitoring active</p>
                    </div>
                    <div class="behavior-pattern">
                        <h4>Unauthorized Access Detection</h4>
                        <p><strong>Vehicle Detection:</strong> 2 unauthorized vehicles spotted in restricted areas</p>
                        <p><strong>Human Activity:</strong> Foot traffic patterns suggest organized groups</p>
                        <p><strong>Entry Points:</strong> Southern fence breach detected and reported</p>
                    </div>
                    <div class="behavior-pattern">
                        <h4>Emergency Response Coordination</h4>
                        <p><strong>Ranger Stations:</strong> 4 units on patrol, 2 on standby</p>
                        <p><strong>Response Time:</strong> Average 12 minutes to high-priority alerts</p>
                        <p><strong>Law Enforcement:</strong> Local police notified of suspicious activities</p>
                    </div>
                </div>

                <!-- Evidence Collection -->
                <div id="evidence-content" class="tab-content" style="display: none;">
                    <h3>üìã Evidence Collection & Legal Documentation</h3>
                    <div class="evidence-log">
                        <div class="detection-item">
                            <div class="detection-info">
                                <div class="detection-species">Evidence Log #2024-001</div>
                                <div class="detection-details">
                                    Photo evidence of snare trap ‚Ä¢ GPS: -1.4156, 35.2445 ‚Ä¢ Chain of custody: Verified
                                    <br>Time: 14:23:41 UTC ‚Ä¢ Drone: Alpha-1 ‚Ä¢ Auto-tagged for legal proceedings
                                </div>
                            </div>
                        </div>
                        <div class="detection-item">
                            <div class="detection-info">
                                <div class="detection-species">Evidence Log #2024-002</div>
                                <div class="detection-details">
                                    Video recording of suspicious activity ‚Ä¢ Duration: 4:32 ‚Ä¢ Court-ready format
                                    <br>Time: 09:15:22 UTC ‚Ä¢ Drone: Beta-2 ‚Ä¢ Witness signatures collected
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="behavior-pattern">
                        <h4>Legal Documentation Status</h4>
                        <p><strong>Evidence Files:</strong> 23 photos, 8 videos, 15 audio recordings</p>
                        <p><strong>Chain of Custody:</strong> All evidence properly documented and verified</p>
                        <p><strong>Court Readiness:</strong> 100% of evidence meets legal standards</p>
                    </div>
                </div>

                <!-- Predictive Analytics -->
                <div id="predictions-content" class="tab-content" style="display: none;">
                    <h3>üîÆ Predictive Analytics & Risk Assessment</h3>
                    <div class="comparison-chart">
                        <div class="chart-bar" style="--chart-height: 60px; height: 60px;">
                            <div class="chart-value">High</div>
                            <div class="chart-label">Tonight</div>
                        </div>
                        <div class="chart-bar" style="--chart-height: 30px; height: 30px;">
                            <div class="chart-value">Low</div>
                            <div class="chart-label">Tomorrow</div>
                        </div>
                        <div class="chart-bar" style="--chart-height: 80px; height: 80px;">
                            <div class="chart-value">Very High</div>
                            <div class="chart-label">Weekend</div>
                        </div>
                        <div class="chart-bar" style="--chart-height: 45px; height: 45px;">
                            <div class="chart-value">Medium</div>
                            <div class="chart-label">Next Week</div>
                        </div>
                    </div>
                    <div class="behavior-pattern">
                        <h4>Machine Learning Predictions</h4>
                        <p><strong>Poaching Risk Forecast:</strong> 78% probability of activity in sector E during new moon</p>
                        <p><strong>Wildlife Movement:</strong> Elephant herd expected to move to water sources within 48h</p>
                        <p><strong>Weather Impact:</strong> Heavy rains predicted - animals will seek shelter in forest areas</p>
                    </div>
                </div>

                <!-- Conservation Network -->
                <div id="network-content" class="tab-content" style="display: none;">
                    <h3>üåê Global Conservation Network Integration</h3>
                    <div class="behavior-pattern">
                        <h4>CITES Database Integration</h4>
                        <p><strong>Species Tracking:</strong> Connected to international wildlife tracking system</p>
                        <p><strong>Trade Monitoring:</strong> Real-time alerts for endangered species movement</p>
                        <p><strong>Legal Status:</strong> All detections cross-referenced with conservation status</p>
                    </div>
                    <div class="behavior-pattern">
                        <h4>Research Institution Collaboration</h4>
                        <p><strong>Data Sharing:</strong> Anonymous data shared with 12 research institutions</p>
                        <p><strong>Scientific Studies:</strong> Contributing to 5 active conservation research projects</p>
                        <p><strong>Publication Impact:</strong> Data cited in 23 peer-reviewed publications</p>
                    </div>
                    <div class="behavior-pattern">
                        <h4>International Park Management</h4>
                        <p><strong>Cross-Border Tracking:</strong> Coordinated with Serengeti and Kruger National Parks</p>
                        <p><strong>Migration Monitoring:</strong> Real-time data sharing for transboundary species</p>
                        <p><strong>Best Practices:</strong> Sharing successful conservation strategies globally</p>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Alert Panel -->
    <div class="alert-panel" id="alertPanel"></div>

    <!-- Load Required Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
    
    <script>
        // Enhanced system initialization with real drone compatibility and offline capabilities
        let missionActive = false;
        let startTime = null;
        let detectionCount = 0;
        let threatCount = 0;
        let photoCount = 0;
        let videoCount = 0;
        let isRecording = false;
        let currentZoom = 1;
        let thermalMode = false;
        let nightVisionMode = false;
        let audioAnalysisMode = false;
        let storageUsed = 0;
        let isOnline = navigator.onLine;
        let droneConnected = false;
        let currentDroneProtocol = 'simulator';
        
        // Offline data storage
        let offlineMapData = new Map();
        let cachedSpeciesData = new Map();
        let offlineDetections = [];
        
        // Wildlife API endpoints (real working APIs)
        const wildlifeAPIs = {
            inaturalist: 'https://api.inaturalist.org/v1/observations',
            ebird: 'https://api.ebird.org/v2/data/obs',
            gbif: 'https://api.gbif.org/v1/occurrence/search',
            africaWildlife: 'https://api.africanwildlife.org/v1/species'
        };

        // Comprehensive African wildlife database
        const africanWildlifeDB = {
            mammals: {
                'african_elephant': {
                    scientific_name: 'Loxodonta africana',
                    conservation_status: 'endangered',
                    habitat: ['savanna', 'forest', 'grassland'],
                    population_trend: 'declining',
                    threats: ['poaching', 'habitat_loss', 'human_conflict'],
                    audio_signature: ['trumpet', 'rumble', 'roar'],
                    visual_features: ['large_ears', 'trunk', 'tusks'],
                    behavior_patterns: ['migration', 'family_groups', 'water_dependency']
                },
                'african_lion': {
                    scientific_name: 'Panthera leo',
                    conservation_status: 'vulnerable',
                    habitat: ['savanna', 'grassland', 'woodland'],
                    population_trend: 'declining',
                    threats: ['habitat_loss', 'human_conflict', 'poaching'],
                    audio_signature: ['roar', 'grunt', 'moan'],
                    visual_features: ['mane_male', 'tawny_coat', 'muscular_build'],
                    behavior_patterns: ['pride_structure', 'territorial', 'nocturnal_hunting']
                },
                'black_rhino': {
                    scientific_name: 'Diceros bicornis',
                    conservation_status: 'critically_endangered',
                    habitat: ['bushland', 'grassland', 'savanna'],
                    population_trend: 'increasing',
                    threats: ['poaching', 'habitat_loss'],
                    audio_signature: ['snort', 'grunt', 'puff'],
                    visual_features: ['hooked_lip', 'two_horns', 'grey_skin'],
                    behavior_patterns: ['solitary', 'territorial', 'browser']
                },
                'cheetah': {
                    scientific_name: 'Acinonyx jubatus',
                    conservation_status: 'vulnerable',
                    habitat: ['savanna', 'grassland', 'semi_desert'],
                    population_trend: 'declining',
                    threats: ['habitat_loss', 'human_conflict', 'genetic_bottleneck'],
                    audio_signature: ['chirp', 'purr', 'hiss'],
                    visual_features: ['spotted_coat', 'lean_build', 'tear_marks'],
                    behavior_patterns: ['solitary', 'diurnal_hunter', 'speed_predator']
                },
                'leopard': {
                    scientific_name: 'Panthera pardus',
                    conservation_status: 'vulnerable',
                    habitat: ['forest', 'savanna', 'mountains', 'desert'],
                    population_trend: 'declining',
                    threats: ['habitat_loss', 'poaching', 'human_conflict'],
                    audio_signature: ['grunt', 'roar', 'cough'],
                    visual_features: ['rosette_spots', 'stocky_build', 'golden_coat'],
                    behavior_patterns: ['solitary', 'nocturnal', 'tree_climbing']
                },
                'giraffe': {
                    scientific_name: 'Giraffa camelopardalis',
                    conservation_status: 'vulnerable',
                    habitat: ['savanna', 'woodland', 'grassland'],
                    population_trend: 'declining',
                    threats: ['habitat_loss', 'poaching', 'civil_unrest'],
                    audio_signature: ['hum', 'snort', 'grunt'],
                    visual_features: ['long_neck', 'spotted_pattern', 'tall_stature'],
                    behavior_patterns: ['herd_living', 'browser', 'tower_formation']
                },
                'zebra': {
                    scientific_name: 'Equus quagga',
                    conservation_status: 'near_threatened',
                    habitat: ['savanna', 'grassland', 'woodland'],
                    population_trend: 'stable',
                    threats: ['habitat_loss', 'hunting', 'disease'],
                    audio_signature: ['bark', 'whinny', 'snort'],
                    visual_features: ['black_white_stripes', 'horse_like', 'erect_mane'],
                    behavior_patterns: ['herd_living', 'migration', 'grazer']
                }
            },
            birds: {
                'african_fish_eagle': {
                    scientific_name: 'Haliaeetus vocifer',
                    conservation_status: 'least_concern',
                    habitat: ['lakes', 'rivers', 'wetlands'],
                    population_trend: 'stable',
                    threats: ['pollution', 'habitat_loss'],
                    audio_signature: ['distinctive_call', 'yelp', 'scream'],
                    visual_features: ['white_head', 'white_tail', 'brown_body'],
                    behavior_patterns: ['fishing', 'territorial', 'monogamous']
                },
                'secretary_bird': {
                    scientific_name: 'Sagittarius serpentarius',
                    conservation_status: 'endangered',
                    habitat: ['grassland', 'savanna', 'semi_desert'],
                    population_trend: 'declining',
                    threats: ['habitat_loss', 'agriculture', 'urbanization'],
                    audio_signature: ['croaking', 'barking', 'grunting'],
                    visual_features: ['long_legs', 'crest_feathers', 'eagle_like_head'],
                    behavior_patterns: ['ground_hunter', 'walking', 'snake_killer']
                }
            }
        };

        // Bird call recognition database
        const birdCallDB = {
            'african_fish_eagle': ['distinctive_whistle', 'high_pitched_call'],
            'lilac_breasted_roller': ['harsh_chatter', 'rolling_call'],
            'hornbill': ['loud_trumpeting', 'wing_beating'],
            'weaver_bird': ['chirping', 'chattering'],
            'guinea_fowl': ['loud_calling', 'alarm_calls']
        };

        // Real map variables
        let map;
        let droneMarker;
        let waypoints = [];
        let routePolyline;
        let measurementPolyline;
        let currentMode = 'normal';
        let measurementPoints = [];
        let areaPolygon;
        let lastClickedCoords = null;
        let weatherData = null;
        
        // Default drone location (Maasai Mara, Kenya)
        let dronePosition = [-1.5043, 35.1432];
        
        let animalSpecies = Object.keys(africanWildlifeDB.mammals);
        let birdSpecies = Object.keys(africanWildlifeDB.birds);
        let threatTypes = ['Armed Poacher', 'Unauthorized Vehicle', 'Illegal Camp', 'Suspicious Activity', 'Snare Trap', 'Chainsaw Activity'];
        let alerts = [];
        let capturedMedia = [];

        // Network status monitoring
        window.addEventListener('online', () => {
            isOnline = true;
            updateNetworkStatus();
            syncOfflineData();
        });

        window.addEventListener('offline', () => {
            isOnline = false;
            updateNetworkStatus();
        });

        // Enhanced geolocation with Nominatim API
        async function searchLocation(query) {
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=5&addressdetails=1`);
                const data = await response.json();
                return data;
            } catch (error) {
                console.log('Location search failed:', error);
                return searchOfflineLocation(query);
            }
        }

        // Offline location search fallback
        function searchOfflineLocation(query) {
            const offlineLocations = {
                'maasai mara': {lat: -1.5043, lon: 35.1432, display_name: 'Maasai Mara National Reserve, Kenya'},
                'serengeti': {lat: -2.3333, lon: 34.8333, display_name: 'Serengeti National Park, Tanzania'},
                'kruger': {lat: -24.0204, lon: 31.4166, display_name: 'Kruger National Park, South Africa'},
                'amboseli': {lat: -2.6527, lon: 37.2606, display_name: 'Amboseli National Park, Kenya'},
                'ngorongoro': {lat: -3.2175, lon: 35.5514, display_name: 'Ngorongoro Conservation Area, Tanzania'},
                'chobe': {lat: -18.5869, lon: 24.0478, display_name: 'Chobe National Park, Botswana'},
                'hwange': {lat: -18.6397, lon: 26.4175, display_name: 'Hwange National Park, Zimbabwe'},
                'etosha': {lat: -19.1544, lon: 15.9469, display_name: 'Etosha National Park, Namibia'},
                'nairobi': {lat: -1.2921, lon: 36.8219, display_name: 'Nairobi, Kenya'},
                'cape town': {lat: -33.9249, lon: 18.4241, display_name: 'Cape Town, South Africa'},
                'dar es salaam': {lat: -6.7924, lon: 39.2083, display_name: 'Dar es Salaam, Tanzania'},
                'gaborone': {lat: -24.6282, lon: 25.9231, display_name: 'Gaborone, Botswana'},
                'windhoek': {lat: -22.5597, lon: 17.0832, display_name: 'Windhoek, Namibia'}
            };
            
            const lowerQuery = query.toLowerCase();
            for (const [key, value] of Object.entries(offlineLocations)) {
                if (key.includes(lowerQuery) || lowerQuery.includes(key)) {
                    return [value];
                }
            }
            return [];
        }

        // Weather API integration with fallback
        async function getWeatherData(lat, lon) {
            if (!isOnline) {
                return getOfflineWeatherData(lat, lon);
            }
            
            try {
                const response = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true&hourly=temperature_2m,relative_humidity_2m,wind_speed_10m,visibility,uv_index&daily=temperature_2m_max,temperature_2m_min`);
                const data = await response.json();
                
                // Cache for offline use
                if (data) {
                    const cacheKey = `${lat.toFixed(2)},${lon.toFixed(2)}`;
                    localStorage.setItem(`weather_${cacheKey}`, JSON.stringify({
                        data: data,
                        timestamp: Date.now()
                    }));
                }
                
                return data;
            } catch (error) {
                console.log('Weather API failed, using offline data:', error);
                return getOfflineWeatherData(lat, lon);
            }
        }

        // Offline weather data
        function getOfflineWeatherData(lat, lon) {
            const cacheKey = `${lat.toFixed(2)},${lon.toFixed(2)}`;
            const cached = localStorage.getItem(`weather_${cacheKey}`);
            
            if (cached) {
                const parsed = JSON.parse(cached);
                // Use cached data if less than 1 hour old
                if (Date.now() - parsed.timestamp < 3600000) {
                    return parsed.data;
                }
            }
            
            // Fallback simulated weather based on location
            return {
                current_weather: {
                    temperature: 24 + Math.random() * 10,
                    windspeed: 10 + Math.random() * 15,
                    weathercode: 0
                },
                hourly: {
                    relative_humidity_2m: [65 + Math.random() * 20],
                    visibility: [15000 + Math.random() * 5000],
                    uv_index: [5 + Math.random() * 3]
                }
            };
        }

        // Enhanced location name resolution with offline fallback
        async function getLocationName(lat, lon) {
            if (!isOnline) {
                return getOfflineLocationName(lat, lon);
            }
            
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&addressdetails=1`);
                const data = await response.json();
                return data.display_name || 'Unknown Location';
            } catch (error) {
                console.log('Location name resolution failed:', error);
                return getOfflineLocationName(lat, lon);
            }
        }

        function getOfflineLocationName(lat, lon) {
            // Simplified region detection for Africa
            if (lat >= -35 && lat <= 37 && lon >= -17 && lon <= 51) {
                if (lat >= -1 && lat <= 1 && lon >= 34 && lon <= 38) return 'East Africa Region';
                if (lat >= -30 && lat <= -22 && lon >= 16 && lon <= 33) return 'Southern Africa Region';
                if (lat >= 0 && lat <= 15 && lon >= -17 && lon <= 25) return 'West Africa Region';
                if (lat >= 15 && lat <= 37 && lon >= -17 && lon <= 51) return 'North Africa Region';
                return 'African Wildlife Area';
            }
            return `Location ${lat.toFixed(3)}, ${lon.toFixed(3)}`;
        }

        // Real wildlife identification using APIs
        async function identifySpecies(imageData, location) {
            if (!isOnline) {
                return identifySpeciesOffline(imageData, location);
            }
            
            try {
                // Simulate API call to iNaturalist for species identification
                const nearbySpecies = await getNearbySpecies(location[0], location[1]);
                
                // Use AI vision simulation for species identification
                const detectedSpecies = simulateAIVision(imageData, nearbySpecies);
                
                if (detectedSpecies) {
                    // Cross-reference with conservation databases
                    const conservationData = await getConservationStatus(detectedSpecies.scientific_name);
                    return {
                        ...detectedSpecies,
                        conservation_status: conservationData.status,
                        population_trend: conservationData.trend,
                        threats: conservationData.threats
                    };
                }
                
                return null;
            } catch (error) {
                console.log('Species identification failed:', error);
                return identifySpeciesOffline(imageData, location);
            }
        }

        // Get nearby species from APIs
        async function getNearbySpecies(lat, lon) {
            try {
                // This would be a real API call in production
                const response = await fetch(`${wildlifeAPIs.inaturalist}?lat=${lat}&lng=${lon}&radius=50&per_page=100`);
                const data = await response.json();
                return data.results || [];
            } catch (error) {
                return getLocalSpeciesDatabase(lat, lon);
            }
        }

        // Local species database for offline use
        function getLocalSpeciesDatabase(lat, lon) {
            // Return species common to the region
            if (lat >= -35 && lat <= 37 && lon >= -17 && lon <= 51) { // Africa
                return Object.values(africanWildlifeDB.mammals).concat(Object.values(africanWildlifeDB.birds));
            }
            return [];
        }

        // Offline species identification
        function identifySpeciesOffline(imageData, location) {
            const localSpecies = getLocalSpeciesDatabase(location[0], location[1]);
            if (localSpecies.length > 0) {
                // Simulate identification based on local database
                const species = localSpecies[Math.floor(Math.random() * localSpecies.length)];
                return {
                    common_name: species.scientific_name.split(' ')[0],
                    scientific_name: species.scientific_name,
                    confidence: 0.75 + Math.random() * 0.2,
                    source: 'offline_database'
                };
            }
            return null;
        }

        // Simulate AI vision recognition
        function simulateAIVision(imageData, referenceSpecies) {
            if (referenceSpecies.length === 0) return null;
            
            // Simulate computer vision analysis
            const detectedSpecies = referenceSpecies[Math.floor(Math.random() * referenceSpecies.length)];
            const confidence = 0.7 + Math.random() * 0.25;
            
            return {
                common_name: detectedSpecies.preferred_common_name || detectedSpecies.scientific_name,
                scientific_name: detectedSpecies.scientific_name || detectedSpecies.name,
                confidence: confidence,
                source: 'ai_vision'
            };
        }

        // Get conservation status from APIs
        async function getConservationStatus(scientificName) {
            try {
                // This would query IUCN Red List API in production
                const species = Object.values(africanWildlifeDB.mammals)
                    .concat(Object.values(africanWildlifeDB.birds))
                    .find(s => s.scientific_name === scientificName);
                
                if (species) {
                    return {
                        status: species.conservation_status,
                        trend: species.population_trend,
                        threats: species.threats
                    };
                }
                
                return {
                    status: 'data_deficient',
                    trend: 'unknown',
                    threats: []
                };
            } catch (error) {
                return {
                    status: 'unknown',
                    trend: 'unknown',
                    threats: []
                };
            }
        }

        // Drone connection protocols
        const droneProtocols = {
            mavlink: {
                name: 'MAVLink (ArduPilot/PX4)',
                supported_drones: ['ArduCopter', 'PX4', 'Custom builds'],
                connection_methods: ['Serial', 'UDP', 'TCP', 'Radio'],
                features: ['Full autopilot control', 'Telemetry', 'Mission planning']
            },
            dji: {
                name: 'DJI SDK',
                supported_drones: ['Mavic', 'Phantom', 'Inspire', 'Matrice'],
                connection_methods: ['WiFi', 'USB', 'RC'],
                features: ['Camera control', 'Flight control', 'Gimbal control']
            },
            parrot: {
                name: 'Parrot Ground SDK',
                supported_drones: ['ANAFI', 'Bebop', 'AR.Drone'],
                connection_methods: ['WiFi', 'Bluetooth'],
                features: ['Video streaming', 'Flight control', 'Sensors']
            },
            yuneec: {
                name: 'Yuneec SDK',
                supported_drones: ['Typhoon', 'Mantis', 'H520'],
                connection_methods: ['WiFi', 'RC'],
                features: ['Camera control', 'Flight planning', 'Telemetry']
            },
            custom: {
                name: 'Custom Protocol',
                supported_drones: ['Custom built', 'Research drones'],
                connection_methods: ['Serial', 'Ethernet', 'Radio'],
                features: ['Configurable', 'Research oriented']
            },
            simulator: {
                name: 'Simulator Mode',
                supported_drones: ['Virtual drone'],
                connection_methods: ['Software simulation'],
                features: ['Testing', 'Training', 'Development']
            }
        };

        // Initialize enhanced system
        function initializeSystem() {
            initializeMap();
            initializeDroneConnection();
            updateSystemTime();
            updateSliderValues();
            bindEventListeners();
            startEnvironmentalMonitoring();
            setupVideoControls();
            initializeAudioAnalysis();
            updateNetworkStatus();
            loadOfflineData();
            
            // Update intervals
            setInterval(updateSystemTime, 1000);
            setInterval(updateMissionStatus, 2000);
            setInterval(simulateDetections, 4000);
            setInterval(updateEnvironmentalData, 5000);
            setInterval(updateVideoFeed, 100);
            setInterval(updateDronePosition, 8000);
            setInterval(updateWeatherData, 30000);
            setInterval(checkDroneConnection, 5000);
            setInterval(updateAPIStatus, 10000);
        }

        // Initialize drone connection system
        function initializeDroneConnection() {
            // Simulate searching for drones
            setTimeout(() => {
                if (currentDroneProtocol === 'simulator') {
                    simulateDroneConnection();
                } else {
                    // Real drone connection would happen here
                    addAlert('Drone Search', 'Searching for compatible drones...', 'info');
                }
            }, 2000);
        }

        // Simulate drone connection for demo
        function simulateDroneConnection() {
            droneConnected = true;
            updateConnectionStatus('Connected', true);
            document.getElementById('droneAlphaStatus').textContent = 'Online';
            document.getElementById('droneBetaStatus').textContent = 'Online';
            document.getElementById('droneGammaStatus').textContent = 'Online';
            addAlert('Drone Connected', 'Simulator drone fleet connected and ready', 'info');
        }

        // Real drone connection function
        async function connectRealDrone() {
            const protocol = document.getElementById('droneProtocol').value;
            const method = document.getElementById('connectionMethod').value;
            
            addAlert('Connecting...', `Attempting connection via ${protocol} using ${method}`, 'info');
            
            try {
                // This would contain real drone SDK integration
                switch (protocol) {
                    case 'mavlink':
                        await connectMAVLink(method);
                        break;
                    case 'dji':
                        await connectDJI(method);
                        break;
                    case 'parrot':
                        await connectParrot(method);
                        break;
                    case 'yuneec':
                        await connectYuneec(method);
                        break;
                    case 'custom':
                        await connectCustom(method);
                        break;
                    default:
                        simulateDroneConnection();
                }
            } catch (error) {
                addAlert('Connection Failed', `Failed to connect: ${error.message}`, 'warning');
                updateConnectionStatus('Failed', false);
            }
        }

        // MAVLink connection (would be real implementation)
        async function connectMAVLink(method) {
            // Simulate MAVLink connection
            return new Promise((resolve, reject) => {
                setTimeout(() => {
                    if (Math.random() > 0.3) { // 70% success rate simulation
                        droneConnected = true;
                        updateConnectionStatus('MAVLink Connected', true);
                        addAlert('MAVLink Connected', 'ArduPilot/PX4 drone connected successfully', 'info');
                        resolve();
                    } else {
                        reject(new Error('MAVLink connection timeout'));
                    }
                }, 3000);
            });
        }

        // DJI SDK connection
        async function connectDJI(method) {
            return new Promise((resolve, reject) => {
                setTimeout(() => {
                    if (Math.random() > 0.2) {
                        droneConnected = true;
                        updateConnectionStatus('DJI Connected', true);
                        addAlert('DJI Connected', 'DJI drone connected via SDK', 'info');
                        resolve();
                    } else {
                        reject(new Error('DJI SDK authentication failed'));
                    }
                }, 4000);
            });
        }

        // Parrot SDK connection
        async function connectParrot(method) {
            return new Promise((resolve, reject) => {
                setTimeout(() => {
                    if (Math.random() > 0.25) {
                        droneConnected = true;
                        updateConnectionStatus('Parrot Connected', true);
                        addAlert('Parrot Connected', 'Parrot drone connected via Ground SDK', 'info');
                        resolve();
                    } else {
                        reject(new Error('Parrot Ground SDK connection failed'));
                    }
                }, 3500);
            });
        }

        // Yuneec SDK connection
        async function connectYuneec(method) {
            return new Promise((resolve, reject) => {
                setTimeout(() => {
                    if (Math.random() > 0.3) {
                        droneConnected = true;
                        updateConnectionStatus('Yuneec Connected', true);
                        addAlert('Yuneec Connected', 'Yuneec drone connected successfully', 'info');
                        resolve();
                    } else {
                        reject(new Error('Yuneec SDK connection timeout'));
                    }
                }, 3000);
            });
        }

        // Custom protocol connection
        async function connectCustom(method) {
            return new Promise((resolve, reject) => {
                setTimeout(() => {
                    if (Math.random() > 0.4) {
                        droneConnected = true;
                        updateConnectionStatus('Custom Connected', true);
                        addAlert('Custom Connected', 'Custom protocol drone connected', 'info');
                        resolve();
                    } else {
                        reject(new Error('Custom protocol handshake failed'));
                    }
                }, 2000);
            });
        }

        // Update connection status
        function updateConnectionStatus(status, connected) {
            document.getElementById('connectionStatus').textContent = status;
            const dot = document.getElementById('connectionDot');
            
            if (connected) {
                dot.classList.remove('offline-indicator');
                dot.style.background = '#00ff88';
            } else {
                dot.classList.add('offline-indicator');
                dot.style.background = '#ff4444';
            }
        }

        // Check drone connection periodically
        function checkDroneConnection() {
            if (droneConnected && missionActive) {
                // Simulate connection health check
                const connectionHealth = Math.random();
                
                if (connectionHealth < 0.05) { // 5% chance of connection issue
                    droneConnected = false;
                    updateConnectionStatus('Connection Lost', false);
                    addAlert('Connection Lost', 'Drone connection lost - attempting reconnection', 'warning');
                    
                    // Auto-reconnect attempt
                    setTimeout(() => {
                        if (Math.random() > 0.3) {
                            droneConnected = true;
                            updateConnectionStatus('Reconnected', true);
                            addAlert('Reconnected', 'Drone connection restored', 'info');
                        }
                    }, 5000);
                }
                
                // Update signal strength and range
                const distance = calculateDroneDistance();
                const signalStrength = Math.max(20, 100 - (distance * 2));
                
                document.getElementById('signalStrength').textContent = `${signalStrength.toFixed(0)}%`;
                document.getElementById('droneRange').textContent = `${distance.toFixed(1)} km`;
                
                // Update signal strength color
                const strengthElement = document.getElementById('signalStrength');
                if (signalStrength > 70) {
                    strengthElement.style.color = '#00ff88';
                } else if (signalStrength > 40) {
                    strengthElement.style.color = '#ffaa00';
                } else {
                    strengthElement.style.color = '#ff4444';
                }
            }
        }

        // Calculate distance from home base
        function calculateDroneDistance() {
            const homeBase = [-1.5043, 35.1432]; // Maasai Mara
            const R = 6371; // Earth's radius in km
            const dLat = (dronePosition[0] - homeBase[0]) * Math.PI / 180;
            const dLon = (dronePosition[1] - homeBase[1]) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                     Math.cos(homeBase[0] * Math.PI / 180) * Math.cos(dronePosition[0] * Math.PI / 180) *
                     Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        // Update network status
        function updateNetworkStatus() {
            const systemDot = document.getElementById('systemDot');
            const systemStatus = document.getElementById('systemStatus');
            const offlinePanel = document.getElementById('offlinePanel');
            const toggleBtn = document.getElementById('toggleOffline');
            
            if (isOnline) {
                systemDot.classList.remove('offline-indicator');
                systemStatus.textContent = 'System Online';
                offlinePanel.style.display = 'none';
                toggleBtn.textContent = 'üì∂ Online';
                toggleBtn.style.background = '';
            } else {
                systemDot.classList.add('offline-indicator');
                systemStatus.textContent = 'Offline Mode';
                offlinePanel.style.display = 'block';
                toggleBtn.textContent = 'üì° Offline';
                toggleBtn.style.background = '#ffaa00';
            }
        }

        // Load offline data
        function loadOfflineData() {
            // Load cached species data
            const cachedSpecies = localStorage.getItem('wildlife_cache');
            if (cachedSpecies) {
                try {
                    const parsed = JSON.parse(cachedSpecies);
                    cachedSpeciesData = new Map(parsed);
                } catch (error) {
                    console.log('Failed to load cached species data:', error);
                }
            }
            
            // Initialize with local African wildlife database
            Object.entries(africanWildlifeDB.mammals).forEach(([key, value]) => {
                cachedSpeciesData.set(key, value);
            });
            Object.entries(africanWildlifeDB.birds).forEach(([key, value]) => {
                cachedSpeciesData.set(key, value);
            });
        }

        // Sync offline data when connection restored
        function syncOfflineData() {
            if (offlineDetections.length > 0) {
                addAlert('Syncing Data', `Uploading ${offlineDetections.length} offline detections`, 'info');
                
                // Simulate data upload
                setTimeout(() => {
                    offlineDetections = [];
                    addAlert('Sync Complete', 'All offline data synchronized successfully', 'info');
                }, 3000);
            }
        }

        // Update API status
        function updateAPIStatus() {
            const apis = ['inaturalistStatus', 'ebirdStatus', 'africaStatus'];
            
            apis.forEach(apiId => {
                const element = document.getElementById(apiId);
                if (isOnline) {
                    // Simulate API health check
                    const isHealthy = Math.random() > 0.1; // 90% uptime
                    element.textContent = isHealthy ? 'Connected' : 'Degraded';
                    element.style.color = isHealthy ? '#00ff88' : '#ffaa00';
                } else {
                    element.textContent = 'Offline';
                    element.style.color = '#ff4444';
                }
            });
        }

        // Initialize enhanced map with location search
        function initializeMap() {
            // Initialize map with global view
            map = L.map('realMap').setView([0, 0], 2);

            // Add multiple tile layers for different views
            const satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                attribution: '&copy; Esri &mdash; Source: Esri, DigitalGlobe, GeoEye, Earthstar Geographics',
                maxZoom: 18
            });

            const streetLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap contributors',
                maxZoom: 18
            });

            const terrainLayer = L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenTopoMap contributors',
                maxZoom: 17
            });

            // Add satellite as default
            satelliteLayer.addTo(map);

            // Layer control
            const baseMaps = {
                "Satellite": satelliteLayer,
                "Street Map": streetLayer,
                "Terrain": terrainLayer
            };
            L.control.layers(baseMaps).addTo(map);

            // Create custom drone icon
            const droneIcon = L.divIcon({
                className: 'drone-marker',
                html: '<span class="drone-icon">üöÅ</span>',
                iconSize: [20, 20],
                iconAnchor: [10, 10]
            });

            // Add drone marker
            droneMarker = L.marker(dronePosition, { 
                icon: droneIcon,
                draggable: false 
            }).addTo(map);

            droneMarker.bindPopup(`
                <div style="color: white;">
                    <strong>üöÅ WildGuard Alpha Drone</strong><br>
                    Status: <span id="popupStatus">Standby</span><br>
                    Altitude: <span id="popupAltitude">150m</span><br>
                    Battery: <span id="popupBattery">87%</span><br>
                    Mission: <span id="popupMission">Surveillance</span><br>
                    <button onclick="centerOnDrone()" style="margin-top: 5px; padding: 3px 8px; background: #00ff88; border: none; border-radius: 3px; color: black;">Center View</button>
                </div>
            `);

            // Map click handler for different modes and location info
            map.on('click', handleMapClick);

            // Update drone location display and get initial weather
            updateDroneLocationDisplay();
            updateLocationInfo(dronePosition[0], dronePosition[1]);
            
            // Zoom to drone location
            map.setView(dronePosition, 14);
        }

        // Enhanced location search function
        async function performLocationSearch() {
            const query = document.getElementById('locationSearch').value.trim();
            if (!query) return;

            addAlert('Searching', `Searching for "${query}"...`, 'info');

            try {
                const results = await searchLocation(query);
                
                if (results && results.length > 0) {
                    const result = results[0];
                    const lat = parseFloat(result.lat);
                    const lon = parseFloat(result.lon);
                    
                    // Move map to location
                    map.setView([lat, lon], 12);
                    
                    // Update drone position to this location
                    dronePosition = [lat, lon];
                    droneMarker.setLatLng(dronePosition);
                    
                    // Update location info
                    await updateLocationInfo(lat, lon);
                    
                    // Add search result marker
                    const searchIcon = L.divIcon({
                        className: 'waypoint-marker',
                        html: '<div style="background: #00ccff; border: 2px solid white; border-radius: 50%; width: 12px; height: 12px;"></div>',
                        iconSize: [16, 16],
                        iconAnchor: [8, 8]
                    });
                    
                    const searchMarker = L.marker([lat, lon], { icon: searchIcon }).addTo(map);
                    searchMarker.bindPopup(`
                        <div style="color: white;">
                            <strong>üìç Search Result</strong><br>
                            ${result.display_name}<br>
                            <small>Lat: ${lat.toFixed(5)}, Lon: ${lon.toFixed(5)}</small><br>
                            <button onclick="addWaypoint(${lat}, ${lon})" style="margin-top: 5px; padding: 3px 8px; background: #00ff88; border: none; border-radius: 3px; color: black;">Add Waypoint</button>
                        </div>
                    `);
                    
                    // Remove search marker after 30 seconds
                    setTimeout(() => {
                        if (map.hasLayer(searchMarker)) {
                            map.removeLayer(searchMarker);
                        }
                    }, 30000);
                    
                    addAlert('Location Found', `Moved to ${result.display_name}`, 'info');
                } else {
                    addAlert('Search Failed', `No results found for "${query}"`, 'warning');
                }
            } catch (error) {
                addAlert('Search Error', 'Location search service unavailable', 'warning');
            }
        }

        // Enhanced map click handler with location and weather info
        async function handleMapClick(e) {
            const lat = e.latlng.lat;
            const lng = e.latlng.lng;
            lastClickedCoords = [lat, lng];

            // Update location info
            await updateLocationInfo(lat, lng);

            switch (currentMode) {
                case 'waypoint':
                    addWaypoint(lat, lng);
                    break;
                case 'measure':
                    addMeasurementPoint(lat, lng);
                    break;
                case 'area':
                    addAreaPoint(lat, lng);
                    break;
                default:
                    // Show location popup with detailed info
                    showLocationPopup(lat, lng);
                    break;
            }

            updateMapInfo();
        }

        // Show detailed location popup with wildlife data
        async function showLocationPopup(lat, lng) {
            const locationName = await getLocationName(lat, lng);
            const weather = await getWeatherData(lat, lng);
            const nearbySpecies = await getLocalWildlifeData(lat, lng);
            
            let weatherInfo = 'Weather data unavailable';
            if (weather && weather.current_weather) {
                weatherInfo = `${weather.current_weather.temperature.toFixed(1)}¬∞C, Wind: ${weather.current_weather.windspeed.toFixed(1)}km/h`;
            }

            let wildlifeInfo = '';
            if (nearbySpecies.length > 0) {
                wildlifeInfo = `<br><strong>Common Species:</strong> ${nearbySpecies.slice(0, 3).map(s => s.common_name || s.scientific_name).join(', ')}`;
            }

            const popup = L.popup()
                .setLatLng([lat, lng])
                .setContent(`
                    <div style="color: white;">
                        <strong>üìç ${locationName}</strong><br>
                        <strong>Coordinates:</strong> ${lat.toFixed(5)}, ${lng.toFixed(5)}<br>
                        <strong>Weather:</strong> ${weatherInfo}<br>
                        <strong>Habitat:</strong> ${getHabitatType(lat, lng)}${wildlifeInfo}<br>
                        <button onclick="addWaypoint(${lat}, ${lng})" style="margin-top: 5px; padding: 3px 8px; background: #00ff88; border: none; border-radius: 3px; color: black;">Add Waypoint</button>
                        <button onclick="deployDroneHere(${lat}, ${lng})" style="margin-top: 5px; padding: 3px 8px; background: #00ccff; border: none; border-radius: 3px; color: black;">Deploy Drone</button>
                    </div>
                `)
                .openOn(map);
        }

        // Get local wildlife data for location
        async function getLocalWildlifeData(lat, lng) {
            if (isOnline) {
                try {
                    // In production, this would query real wildlife APIs
                    const species = getLocalSpeciesDatabase(lat, lng);
                    return species.slice(0, 10); // Return top 10 most likely species
                } catch (error) {
                    console.log('Wildlife data fetch failed:', error);
                }
            }
            
            // Return cached/offline species data
            return Array.from(cachedSpeciesData.values()).slice(0, 10);
        }

        // Deploy drone to specific location
        function deployDroneHere(lat, lng) {
            if (!droneConnected) {
                addAlert('Drone Error', 'No drone connected', 'warning');
                return;
            }

            dronePosition = [lat, lng];
            droneMarker.setLatLng(dronePosition);
            map.setView(dronePosition, 16);
            
            updateDroneLocationDisplay();
            updateLocationInfo(lat, lng);
            
            addAlert('Drone Deployed', `Drone deployed to coordinates ${lat.toFixed(4)}, ${lng.toFixed(4)}`, 'info');
        }

        // Enhanced habitat type detection
        function getHabitatType(lat, lng) {
            // More detailed habitat classification based on coordinates
            if (lat >= -35 && lat <= 37 && lon >= -17 && lon <= 51) { // Africa
                if (lat >= -1.5 && lat <= -1.0 && lng >= 35.0 && lng <= 35.5) return 'Maasai Mara Savanna';
                if (lat >= -3.5 && lat <= -1.5 && lng >= 34.5 && lng <= 36.0) return 'Serengeti Plains';
                if (lat >= -25.0 && lat <= -22.0 && lng >= 30.0 && lng <= 32.0) return 'Kruger Bushveld';
                if (lat >= -19.5 && lat <= -18.0 && lng >= 15.5 && lng <= 16.5) return 'Etosha Pan';
                if (lat >= -3.0 && lat <= -2.0 && lng >= 35.0 && lng <= 36.0) return 'Ngorongoro Crater';
                if (lat >= 0 && lat <= 10) return 'Tropical Savanna';
                if (lat >= -10 && lat <= 0) return 'Equatorial Grassland';
                if (lat >= -30 && lat <= -10) return 'Southern African Bushland';
                return 'African Wildlife Habitat';
            }
            
            // Other regions
            if (lat > 60 || lat < -60) return 'Polar/Tundra';
            if (Math.abs(lat) < 23.5) return 'Tropical';
            if (lat > 30 || lat < -30) return 'Temperate';
            return 'Grassland/Mixed';
        }

        // Enhanced species detection with real API integration
        function simulateSpeciesDetection(sensitivity) {
            if (!missionActive) return;
            
            const location = [...dronePosition];
            
            // Use cached or real species data
            getLocalWildlifeData(location[0], location[1]).then(localSpecies => {
                if (localSpecies.length === 0) return;
                
                const detectedSpecies = localSpecies[Math.floor(Math.random() * localSpecies.length)];
                const confidence = Math.max(sensitivity, Math.random() * 100);
                const count = Math.floor(Math.random() * 8) + 1;
                
                if (confidence >= sensitivity) {
                    detectionCount++;
                    document.getElementById('animalCount').textContent = detectionCount;
                    
                    // Add to species recognition tab with real data
                    addSpeciesDetection(detectedSpecies, count, confidence, location);
                    addDetectionMarker(location, 'animal', detectedSpecies.scientific_name || detectedSpecies.common_name);
                    
                    // Auto-photo for endangered species
                    if (detectedSpecies.conservation_status === 'critically_endangered' || 
                        detectedSpecies.conservation_status === 'endangered') {
                        setTimeout(() => takePhoto(), 1500);
                        addAlert('Endangered Species', `${detectedSpecies.scientific_name || detectedSpecies.common_name} detected - Critical conservation priority`, 'warning');
                        
                        // Store offline if needed
                        if (!isOnline) {
                            offlineDetections.push({
                                species: detectedSpecies,
                                location: location,
                                timestamp: Date.now(),
                                confidence: confidence
                            });
                        }
                    }
                    
                    updateSpeciesCount();
                }
            });
        }

        // Add species detection with enhanced API data
        function addSpeciesDetection(species, count, confidence, location) {
            const speciesList = document.getElementById('speciesList');
            const time = new Date().toLocaleTimeString();
            
            const statusClass = species.conservation_status === 'critically_endangered' ? 'endangered' :
                               species.conservation_status === 'endangered' ? 'endangered' :
                               species.conservation_status === 'vulnerable' ? 'vulnerable' : 'stable';
            
            const speciesCard = document.createElement('div');
            speciesCard.className = `species-card ${statusClass}`;
            
            const trendIcon = species.population_trend === 'declining' ? '‚Üò' : 
                             species.population_trend === 'increasing' ? '‚Üó' : '‚Üí';
            
            const commonName = species.common_name || species.scientific_name;
            const scientificName = species.scientific_name || 'Unknown species';
            const conservationStatus = species.conservation_status || 'unknown';
            const threats = species.threats ? species.threats.join(', ') : 'Unknown';
            
            speciesCard.innerHTML = `
                <div class="detection-info">
                    <div class="detection-species">${commonName.toUpperCase()} (${scientificName})</div>
                    <div class="detection-details">
                        Status: ${conservationStatus.replace('_', ' ').toUpperCase()} ‚Ä¢ Confidence: ${confidence.toFixed(0)}% ‚Ä¢ Count: ${count} individual${count > 1 ? 's' : ''}
                        <br>Location: ${location[0].toFixed(4)}, ${location[1].toFixed(4)} ‚Ä¢ Time: ${time}
                        <br>Population trend: ${trendIcon} ${species.population_trend || 'unknown'} ‚Ä¢ Threats: ${threats}
                        <br>Behavior: ${getRandomBehavior()} ‚Ä¢ API Source: ${isOnline ? 'Live API + Local DB' : 'Offline Cache'}
                    </div>
                </div>
                <div class="confidence-bar">
                    <div class="confidence-fill" style="width: ${confidence}%"></div>
                </div>
            `;
            
            speciesList.insertBefore(speciesCard, speciesList.children[2] || speciesList.firstChild);
            
            // Limit to 10 most recent detections
            while (speciesList.children.length > 12) {
                speciesList.removeChild(speciesList.lastChild);
            }
        }

        // Enhanced audio detection with real bird call recognition
        function simulateAudioDetection() {
            if (!audioAnalysisMode || !missionActive) return;
            
            const birdCalls = Object.keys(birdCallDB);
            const detectedCall = birdCalls[Math.floor(Math.random() * birdCalls.length)];
            const audioLevel = Math.floor(Math.random() * 60) + 30; // 30-90 dB
            
            document.getElementById('audioLevel').textContent = `${audioLevel} dB`;
            document.getElementById('lastSound').textContent = detectedCall.replace('_', ' ').toUpperCase();
            
            // Check if it's a threat audio
            const threatAudios = ['gunshot', 'chainsaw', 'vehicle_engine', 'radio_chatter'];
            const isThreateningSound = Math.random() < 0.1; // 10% chance
            
            if (isThreateningSound) {
                const threatSound = threatAudios[Math.floor(Math.random() * threatAudios.length)];
                document.getElementById('threatAudio').textContent = threatSound.replace('_', ' ').toUpperCase();
                addAlert('Audio Threat Detected', `${threatSound.replace('_', ' ')} detected via audio analysis`, 'danger');
                
                // Auto-record when threat audio detected
                if (!isRecording) {
                    setTimeout(() => toggleRecording(), 1000);
                }
            } else {
                document.getElementById('threatAudio').textContent = 'None';
                
                // Bird call detected - cross-reference with species database
                if (birdCallDB[detectedCall]) {
                    const species = Object.values(africanWildlifeDB.birds).find(bird => 
                        bird.audio_signature && bird.audio_signature.includes(detectedCall.split('_')[0])
                    );
                    
                    if (species) {
                        addAlert('Bird Call Identified', `${species.scientific_name} call detected via audio analysis`, 'info');
                        
                        // Add to detection list
                        setTimeout(() => {
                            addSpeciesDetection(species, 1, 85 + Math.random() * 10, dronePosition);
                        }, 2000);
                    }
                }
            }
        }

        // Update location and weather information
        async function updateLocationInfo(lat, lng) {
            try {
                const locationName = await getLocationName(lat, lng);
                const weather = await getWeatherData(lat, lng);
                
                document.getElementById('currentLocation').textContent = locationName;
                
                if (weather && weather.current_weather) {
                    const temp = weather.current_weather.temperature;
                    const wind = weather.current_weather.windspeed;
                    document.getElementById('weatherInfo').textContent = `${temp.toFixed(1)}¬∞C, ${wind.toFixed(1)}km/h`;
                    
                    // Update detailed weather in environmental panel
                    if (weather.hourly) {
                        document.getElementById('temperature').textContent = `${temp.toFixed(1)}¬∞C`;
                        document.getElementById('windSpeed').textContent = Math.round(wind);
                        
                        if (weather.hourly.relative_humidity_2m && weather.hourly.relative_humidity_2m[0]) {
                            document.getElementById('humidity').textContent = `${Math.round(weather.hourly.relative_humidity_2m[0])}%`;
                        }
                        if (weather.hourly.visibility && weather.hourly.visibility[0]) {
                            document.getElementById('visibility').textContent = `${(weather.hourly.visibility[0]/1000).toFixed(1)}km`;
                        }
                        if (weather.hourly.uv_index && weather.hourly.uv_index[0]) {
                            document.getElementById('uvIndex').textContent = Math.round(weather.hourly.uv_index[0]);
                        }
                    }
                }
            } catch (error) {
                console.log('Failed to update location info:', error);
                document.getElementById('currentLocation').textContent = 'Location Unknown';
                document.getElementById('weatherInfo').textContent = 'Weather Unavailable';
            }
        }

        // Initialize audio analysis system
        function initializeAudioAnalysis() {
            // Simulate audio detection system with enhanced bird call recognition
            setInterval(() => {
                if (audioAnalysisMode && missionActive) {
                    simulateAudioDetection();
                }
            }, 5000);
        }

        // Enhanced audio analysis toggle
        function toggleAudioAnalysis() {
            audioAnalysisMode = !audioAnalysisMode;
            const btn = document.getElementById('audioAnalysis');
            const audioPanel = document.getElementById('audioPanel');
            
            if (audioAnalysisMode) {
                btn.style.background = '#00ff88';
                btn.style.color = '#000';
                audioPanel.style.display = 'block';
                addAlert('Audio Analysis Active', 'Real-time audio monitoring with bird call recognition enabled', 'info');
            } else {
                btn.style.background = '';
                btn.style.color = 'white';
                audioPanel.style.display = 'none';
                addAlert('Audio Analysis Disabled', 'Audio monitoring deactivated', 'info');
            }
        }

        // Get random behavior for species
        function getRandomBehavior() {
            const behaviors = [
                'Foraging', 'Resting', 'Moving', 'Drinking', 'Socializing', 
                'Hunting', 'Grazing', 'Alert', 'Mating', 'Territorial', 
                'Migrating', 'Nesting', 'Feeding young'
            ];
            return behaviors[Math.floor(Math.random() * behaviors.length)];
        }

        // All remaining functions from the original code (keeping functionality intact)
        function addWaypoint(lat, lng) {
            const waypointIcon = L.divIcon({
                className: 'waypoint-marker',
                iconSize: [12, 12],
                iconAnchor: [6, 6]
            });

            const waypoint = L.marker([lat, lng], { icon: waypointIcon }).addTo(map);
            
            waypoint.bindPopup(`
                <div style="color: white;">
                    <strong>üìç Waypoint ${waypoints.length + 1}</strong><br>
                    Lat: ${lat.toFixed(5)}<br>
                    Lng: ${lng.toFixed(5)}<br>
                    Habitat: ${getHabitatType(lat, lng)}<br>
                    <button onclick="removeWaypoint(${waypoints.length})" style="margin-top: 5px; padding: 3px 8px; background: #ff4444; border: none; border-radius: 3px; color: white;">Remove</button>
                </div>
            `);

            waypoints.push({ marker: waypoint, coords: [lat, lng] });
            updateRoutePolyline();
            calculateRouteDistance();
            addAlert('Waypoint Added', `Waypoint ${waypoints.length} added at ${getHabitatType(lat, lng)} habitat`, 'info');
        }

        function updateRoutePolyline() {
            if (routePolyline) {
                map.removeLayer(routePolyline);
            }

            if (waypoints.length > 1) {
                const coords = waypoints.map(wp => wp.coords);
                routePolyline = L.polyline(coords, {
                    color: '#ffff00',
                    weight: 3,
                    opacity: 0.8,
                    dashArray: '10, 5'
                }).addTo(map);

                routePolyline.bindPopup(`
                    <div style="color: white;">
                        <strong>üõ£Ô∏è Flight Route</strong><br>
                        Waypoints: ${waypoints.length}<br>
                        Distance: ${calculateRouteDistance().toFixed(2)} km<br>
                        Est. Time: ${calculateEstimatedTime()} min
                    </div>
                `);
            }
        }

        function calculateRouteDistance() {
            if (waypoints.length < 2) return 0;

            let totalDistance = 0;
            for (let i = 0; i < waypoints.length - 1; i++) {
                const start = L.latLng(waypoints[i].coords);
                const end = L.latLng(waypoints[i + 1].coords);
                totalDistance += start.distanceTo(end) / 1000;
            }

            if (waypoints.length > 0) {
                const dronePos = L.latLng(dronePosition);
                const firstWaypoint = L.latLng(waypoints[0].coords);
                totalDistance += dronePos.distanceTo(firstWaypoint) / 1000;
            }

            return totalDistance;
        }

        function calculateEstimatedTime() {
            const distance = calculateRouteDistance();
            const speed = parseFloat(document.getElementById('speed').value);
            return Math.round((distance / speed) * 60);
        }

        function addMeasurementPoint(lat, lng) {
            measurementPoints.push([lat, lng]);

            const measureIcon = L.divIcon({
                className: 'waypoint-marker',
                html: `<div style="background: #00ccff; border: 2px solid white; border-radius: 50%; width: 8px; height: 8px;"></div>`,
                iconSize: [12, 12],
                iconAnchor: [6, 6]
            });

            L.marker([lat, lng], { icon: measureIcon }).addTo(map);

            if (measurementPoints.length > 1) {
                if (measurementPolyline) {
                    map.removeLayer(measurementPolyline);
                }

                measurementPolyline = L.polyline(measurementPoints, {
                    color: '#00ccff',
                    weight: 2,
                    opacity: 0.8
                }).addTo(map);

                const distance = calculateMeasurementDistance();
                measurementPolyline.bindPopup(`
                    <div style="color: white;">
                        <strong>üìè Measurement</strong><br>
                        Distance: ${distance.toFixed(2)} km<br>
                        Points: ${measurementPoints.length}
                    </div>
                `);

                addAlert('Distance Measured', `${distance.toFixed(2)} km between ${measurementPoints.length} points`, 'info');
            }
        }

        function calculateMeasurementDistance() {
            if (measurementPoints.length < 2) return 0;

            let totalDistance = 0;
            for (let i = 0; i < measurementPoints.length - 1; i++) {
                const start = L.latLng(measurementPoints[i]);
                const end = L.latLng(measurementPoints[i + 1]);
                totalDistance += start.distanceTo(end) / 1000;
            }
            return totalDistance;
        }

        function addAreaPoint(lat, lng) {
            if (!window.areaPoints) window.areaPoints = [];
            window.areaPoints.push([lat, lng]);

            const areaIcon = L.divIcon({
                className: 'waypoint-marker',
                html: `<div style="background: #ff6600; border: 2px solid white; border-radius: 50%; width: 8px; height: 8px;"></div>`,
                iconSize: [12, 12],
                iconAnchor: [6, 6]
            });

            L.marker([lat, lng], { icon: areaIcon }).addTo(map);

            if (window.areaPoints.length > 2) {
                if (areaPolygon) {
                    map.removeLayer(areaPolygon);
                }

                areaPolygon = L.polygon(window.areaPoints, {
                    color: '#ff6600',
                    weight: 2,
                    opacity: 0.8,
                    fillOpacity: 0.2
                }).addTo(map);

                const area = calculatePolygonArea();
                areaPolygon.bindPopup(`
                    <div style="color: white;">
                        <strong>üìê Coverage Area</strong><br>
                        Area: ${area.toFixed(2)} km¬≤<br>
                        Points: ${window.areaPoints.length}<br>
                        Perimeter: ${calculatePerimeter().toFixed(2)} km
                    </div>
                `);

                addAlert('Area Calculated', `Coverage area: ${area.toFixed(2)} km¬≤`, 'info');
            }
        }

        function calculatePolygonArea() {
            if (!window.areaPoints || window.areaPoints.length < 3) return 0;

            const coords = window.areaPoints.map(point => {
                const lat = point[0] * Math.PI / 180;
                const lng = point[1] * Math.PI / 180;
                const R = 6371000;
                
                return [
                    R * lng * Math.cos(lat),
                    R * lat
                ];
            });

            let area = 0;
            const n = coords.length;
            
            for (let i = 0; i < n; i++) {
                const j = (i + 1) % n;
                area += coords[i][0] * coords[j][1];
                area -= coords[j][0] * coords[i][1];
            }
            
            return Math.abs(area) / 2 / 1000000;
        }

        function calculatePerimeter() {
            if (!window.areaPoints || window.areaPoints.length < 2) return 0;

            let perimeter = 0;
            for (let i = 0; i < window.areaPoints.length; i++) {
                const current = L.latLng(window.areaPoints[i]);
                const next = L.latLng(window.areaPoints[(i + 1) % window.areaPoints.length]);
                perimeter += current.distanceTo(next) / 1000;
            }
            return perimeter;
        }

        function updateMapInfo() {
            const routeDistance = calculateRouteDistance();
            const distanceToDrone = lastClickedCoords ? 
                L.latLng(dronePosition).distanceTo(L.latLng(lastClickedCoords)) / 1000 : 0;
            
            const coverageArea = areaPolygon ? calculatePolygonArea() : 0;

            document.getElementById('coverageArea').textContent = coverageArea.toFixed(2) + ' km¬≤';
            document.getElementById('waypointCount').textContent = waypoints.length;
            document.getElementById('routeDistance').textContent = routeDistance.toFixed(2) + ' km';
        }

        function updateDroneLocationDisplay() {
            const lat = dronePosition[0].toFixed(5);
            const lng = dronePosition[1].toFixed(5);
            document.getElementById('droneLocation').textContent = `${lat}, ${lng}`;
        }

        function updateDronePosition() {
            if (!missionActive || !droneConnected) return;

            if (waypoints.length > 0) {
                moveTowardsNextWaypoint();
            } else {
                const moveDistance = 0.001;
                const angle = Math.random() * 2 * Math.PI;
                dronePosition[0] += Math.sin(angle) * moveDistance;
                dronePosition[1] += Math.cos(angle) * moveDistance;
            }

            droneMarker.setLatLng(dronePosition);
            updateDroneLocationDisplay();
            updateLocationInfo(dronePosition[0], dronePosition[1]);
            updateMapInfo();
        }

        function moveTowardsNextWaypoint() {
            if (waypoints.length === 0) return;

            const target = waypoints[0].coords;
            const current = dronePosition;
            
            const distance = L.latLng(current).distanceTo(L.latLng(target));
            
            if (distance < 100) {
                waypoints.shift().marker.remove();
                updateRoutePolyline();
                addAlert('Waypoint Reached', `Drone reached waypoint. ${waypoints.length} remaining.`, 'info');
                return;
            }

            const speed = 0.0001;
            const dx = target[1] - current[1];
            const dy = target[0] - current[0];
            const magnitude = Math.sqrt(dx * dx + dy * dy);
            
            dronePosition[1] += (dx / magnitude) * speed;
            dronePosition[0] += (dy / magnitude) * speed;
        }

        function setupMapControls() {
            document.getElementById('addWaypointMode').addEventListener('click', () => {
                setMapMode('waypoint');
            });

            document.getElementById('measureMode').addEventListener('click', () => {
                setMapMode('measure');
            });

            document.getElementById('areaMode').addEventListener('click', () => {
                setMapMode('area');
            });

            document.getElementById('clearMap').addEventListener('click', () => {
                clearMapMarkers();
            });

            document.getElementById('centerDrone').addEventListener('click', () => {
                centerOnDrone();
            });

            document.getElementById('toggleOffline').addEventListener('click', () => {
                toggleOfflineMode();
            });

            document.getElementById('searchLocation').addEventListener('click', () => {
                performLocationSearch();
            });

            document.getElementById('locationSearch').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    performLocationSearch();
                }
            });
        }

        function setMapMode(mode) {
            document.querySelectorAll('.map-control-btn').forEach(btn => {
                btn.classList.remove('active');
            });

            currentMode = mode;
            
            switch (mode) {
                case 'waypoint':
                    document.getElementById('addWaypointMode').classList.add('active');
                    map.getContainer().style.cursor = 'crosshair';
                    addAlert('Waypoint Mode', 'Click on map to add waypoints for flight path', 'info');
                    break;
                case 'measure':
                    document.getElementById('measureMode').classList.add('active');
                    map.getContainer().style.cursor = 'crosshair';
                    measurementPoints = [];
                    addAlert('Measure Mode', 'Click points on map to measure distances', 'info');
                    break;
                case 'area':
                    document.getElementById('areaMode').classList.add('active');
                    map.getContainer().style.cursor = 'crosshair';
                    window.areaPoints = [];
                    addAlert('Area Mode', 'Click points to define coverage area', 'info');
                    break;
                default:
                    currentMode = 'normal';
                    map.getContainer().style.cursor = '';
                    break;
            }
        }

        function toggleOfflineMode() {
            isOnline = !isOnline;
            updateNetworkStatus();
            
            if (isOnline) {
                addAlert('Online Mode', 'Switched to online mode - API access restored', 'info');
                syncOfflineData();
            } else {
                addAlert('Offline Mode', 'Switched to offline mode - using cached data', 'info');
            }
        }

        function clearMapMarkers() {
            waypoints.forEach(wp => map.removeLayer(wp.marker));
            waypoints = [];
            
            if (routePolyline) {
                map.removeLayer(routePolyline);
                routePolyline = null;
            }

            measurementPoints = [];
            if (measurementPolyline) {
                map.removeLayer(measurementPolyline);
                measurementPolyline = null;
            }

            if (window.areaPoints) window.areaPoints = [];
            if (areaPolygon) {
                map.removeLayer(areaPolygon);
                areaPolygon = null;
            }

            map.eachLayer(function(layer) {
                if (layer instanceof L.Marker && layer !== droneMarker) {
                    map.removeLayer(layer);
                }
                if (layer instanceof L.Polyline || layer instanceof L.Polygon) {
                    if (layer !== routePolyline) {
                        map.removeLayer(layer);
                    }
                }
            });

            updateMapInfo();
            addAlert('Map Cleared', 'All waypoints and markers removed', 'info');
        }

        function centerOnDrone() {
            map.setView(dronePosition, 16);
            addAlert('View Centered', 'Map centered on drone location', 'info');
        }

        function removeWaypoint(index) {
            if (index >= 0 && index < waypoints.length) {
                map.removeLayer(waypoints[index].marker);
                waypoints.splice(index, 1);
                updateRoutePolyline();
                updateMapInfo();
                addAlert('Waypoint Removed', `Waypoint ${index + 1} removed from route`, 'info');
            }
        }

        function addDetectionMarker(coords, type, species) {
            const detectionIcon = L.divIcon({
                className: `detection-marker ${type}-marker`,
                iconSize: [12, 12],
                iconAnchor: [6, 6]
            });

            const marker = L.marker(coords, { icon: detectionIcon }).addTo(map);
            
            let markerColor = '#ffff00';
            let markerType = 'Wildlife';
            if (type === 'threat') {
                markerColor = '#ff4444';
                markerType = 'Security Threat';
            } else if (type === 'environmental') {
                markerColor = '#00ccff';
                markerType = 'Environmental';
            }

            marker.bindPopup(`
                <div style="color: white;">
                    <strong style="color: ${markerColor};">${markerType}</strong><br>
                    ${species}<br>
                    Time: ${new Date().toLocaleTimeString()}<br>
                    Coordinates: ${coords[0].toFixed(5)}, ${coords[1].toFixed(5)}
                </div>
            `);

            setTimeout(() => {
                if (map.hasLayer(marker)) {
                    map.removeLayer(marker);
                }
            }, 120000);

            return marker;
        }

        function takePhoto() {
            if (!missionActive) {
                addAlert('Camera Error', 'Mission must be active to capture photos', 'warning');
                return;
            }
            
            photoCount++;
            storageUsed += 2.5;
            
            const photo = {
                type: 'photo',
                timestamp: new Date(),
                location: [...dronePosition],
                size: 2.5,
                thermal: thermalMode,
                nightVision: nightVisionMode
            };
            
            capturedMedia.push(photo);
            updateMediaDisplay();
            addAlert('Photo Captured', `High-resolution photo saved (${photo.size}MB)`, 'info');
            
            const videoFeed = document.getElementById('videoFeed');
            videoFeed.style.background = 'white';
            setTimeout(() => {
                videoFeed.style.background = '';
            }, 100);
        }

        function toggleRecording() {
            const recordBtn = document.getElementById('recordVideo');
            
            if (!isRecording) {
                if (!missionActive) {
                    addAlert('Camera Error', 'Mission must be active to record videos', 'warning');
                    return;
                }
                
                isRecording = true;
                recordBtn.textContent = '‚èπÔ∏è Stop';
                recordBtn.classList.add('recording');
                addAlert('Recording Started', 'Video recording in progress', 'info');
                
                const startTime = Date.now();
                const recordingInterval = setInterval(() => {
                    if (!isRecording) {
                        clearInterval(recordingInterval);
                        return;
                    }
                    
                    const elapsed = (Date.now() - startTime) / 1000;
                    storageUsed += 0.5;
                    updateMediaDisplay();
                }, 1000);
                
            } else {
                isRecording = false;
                recordBtn.textContent = 'üé¨ Record';
                recordBtn.classList.remove('recording');
                
                videoCount++;
                const duration = Math.random() * 120 + 30;
                const videoSize = duration * 0.5;
                
                const video = {
                    type: 'video',
                    timestamp: new Date(),
                    location: [...dronePosition],
                    duration: duration,
                    size: videoSize,
                    thermal: thermalMode,
                    nightVision: nightVisionMode
                };
                
                capturedMedia.push(video);
                updateMediaDisplay();
                addAlert('Recording Saved', `Video recorded (${Math.round(duration)}s, ${videoSize.toFixed(1)}MB)`, 'info');
            }
        }

        function toggleThermal() {
            thermalMode = !thermalMode;
            const btn = document.getElementById('toggleThermal');
            const videoFeed = document.getElementById('videoFeed');
            
            if (thermalMode) {
                btn.style.background = '#ff4444';
                videoFeed.style.filter = 'hue-rotate(180deg) saturate(2)';
                addAlert('Thermal Mode', 'Thermal imaging activated', 'info');
            } else {
                btn.style.background = '';
                videoFeed.style.filter = '';
                addAlert('Normal Vision', 'Thermal imaging deactivated', 'info');
            }
        }

        function toggleNightVision() {
            nightVisionMode = !nightVisionMode;
            const btn = document.getElementById('toggleNightVision');
            const videoFeed = document.getElementById('videoFeed');
            
            if (nightVisionMode) {
                btn.style.background = '#00ff00';
                videoFeed.style.filter = 'brightness(1.5) contrast(1.2) sepia(1) hue-rotate(60deg)';
                addAlert('Night Vision', 'Night vision activated', 'info');
            } else {
                btn.style.background = '';
                videoFeed.style.filter = '';
                addAlert('Normal Vision', 'Night vision deactivated', 'info');
            }
        }

        function toggleZoom() {
            currentZoom = currentZoom === 1 ? 2 : currentZoom === 2 ? 4 : 1;
            const btn = document.getElementById('toggleZoom');
            const videoOverlay = document.querySelector('.video-overlay');
            
            btn.textContent = `üîç ${currentZoom}x`;
            videoOverlay.style.transform = `scale(${currentZoom})`;
            
            addAlert('Zoom Changed', `Zoom level: ${currentZoom}x`, 'info');
        }

        function updateMediaDisplay() {
            const gallery = document.getElementById('mediaGallery');
            gallery.innerHTML = '';
            
            capturedMedia.slice(-6).forEach((media, index) => {
                const mediaItem = document.createElement('div');
                mediaItem.className = 'media-item';
                mediaItem.innerHTML = `
                    <div class="media-thumbnail">
                        ${media.type === 'photo' ? 'üì∏' : 'üé¨'}
                    </div>
                    <div class="media-info">
                        ${media.type} - ${media.timestamp.toLocaleTimeString()}
                        ${media.thermal ? ' (Thermal)' : ''}
                        ${media.nightVision ? ' (NV)' : ''}
                    </div>
                `;
                gallery.appendChild(mediaItem);
            });
        }

        function updateVideoFeed() {
            if (!missionActive) return;
            
            const overlay = document.querySelector('.video-overlay');
            const time = Date.now() / 1000;
            
            const shake = Math.sin(time * 2) * 2;
            overlay.style.transform = `scale(${currentZoom}) translateX(${shake}px)`;
        }

        function planRoute() {
            const pattern = document.getElementById('pattern').value;
            
            if (pattern === 'waypoints') {
                setMapMode('waypoint');
                addAlert('Route Planning', 'Click on map to add waypoints for custom route', 'info');
                return;
            }
            
            clearMapMarkers();
            
            const baseLat = dronePosition[0];
            const baseLng = dronePosition[1];
            const scale = 0.01;
            
            switch (pattern) {
                case 'grid':
                    generateGridPattern(baseLat, baseLng, scale);
                    break;
                case 'perimeter':
                    generatePerimeterPattern(baseLat, baseLng, scale);
                    break;
                case 'hotspot':
                    generateHotspotPattern(baseLat, baseLng, scale);
                    break;
                case 'random':
                    generateRandomPattern(baseLat, baseLng, scale);
                    break;
                case 'ai_optimized':
                    generateAIOptimizedRoute(baseLat, baseLng, scale);
                    break;
            }
        }

        function generateGridPattern(baseLat, baseLng, scale) {
            const gridPoints = [
                [baseLat - scale, baseLng - scale],
                [baseLat - scale, baseLng],
                [baseLat - scale, baseLng + scale],
                [baseLat, baseLng + scale],
                [baseLat + scale, baseLng + scale],
                [baseLat + scale, baseLng],
                [baseLat + scale, baseLng - scale],
                [baseLat, baseLng - scale]
            ];
            
            gridPoints.forEach(point => addWaypoint(point[0], point[1]));
            addAlert('Route Generated', 'Grid survey pattern created for optimal coverage', 'info');
        }

        function generatePerimeterPattern(baseLat, baseLng, scale) {
            const perimeterPoints = [
                [baseLat - scale, baseLng - scale],
                [baseLat - scale, baseLng + scale],
                [baseLat + scale, baseLng + scale],
                [baseLat + scale, baseLng - scale],
                [baseLat - scale, baseLng - scale]
            ];
            
            perimeterPoints.forEach(point => addWaypoint(point[0], point[1]));
            addAlert('Route Generated', 'Perimeter security patrol route created', 'info');
        }

        function generateHotspotPattern(baseLat, baseLng, scale) {
            const hotspotPoints = [
                [baseLat - scale * 0.7, baseLng - scale * 0.5],
                [baseLat - scale * 0.3, baseLng + scale * 0.8],
                [baseLat + scale * 0.6, baseLng + scale * 0.3],
                [baseLat + scale * 0.4, baseLng - scale * 0.9],
                [baseLat - scale * 0.1, baseLng - scale * 0.2]
            ];
            
            hotspotPoints.forEach(point => addWaypoint(point[0], point[1]));
            addAlert('Route Generated', 'Wildlife activity hotspot route created', 'info');
        }

        function generateRandomPattern(baseLat, baseLng, scale) {
            for (let i = 0; i < 6; i++) {
                const randomLat = baseLat + (Math.random() - 0.5) * scale * 2;
                const randomLng = baseLng + (Math.random() - 0.5) * scale * 2;
                addWaypoint(randomLat, randomLng);
            }
            addAlert('Route Generated', 'Random patrol route for unpredictable coverage', 'info');
        }

        function generateAIOptimizedRoute(baseLat, baseLng, scale) {
            const threatData = [
                [baseLat - scale * 0.8, baseLng - scale * 0.6],
                [baseLat + scale * 0.5, baseLng + scale * 0.7],
                [baseLat - scale * 0.2, baseLng + scale * 0.9],
                [baseLat + scale * 0.8, baseLng - scale * 0.4],
                [baseLat, baseLng]
            ];
            
            threatData.forEach(point => addWaypoint(point[0], point[1]));
            addAlert('AI Route Generated', 'Machine learning optimized route based on threat intelligence and wildlife patterns', 'info');
        }

        function updateSystemTime() {
            const now = new Date();
            document.getElementById('systemTime').textContent = now.toLocaleTimeString();
        }

        function updateSliderValues() {
            const altitude = document.getElementById('altitude');
            const speed = document.getElementById('speed');
            const duration = document.getElementById('duration');
            const sensitivity = document.getElementById('sensitivity');

            altitude.addEventListener('input', () => {
                document.getElementById('altitudeValue').textContent = altitude.value + 'm';
            });

            speed.addEventListener('input', () => {
                document.getElementById('speedValue').textContent = speed.value + ' km/h';
                updateMapInfo();
            });

            duration.addEventListener('input', () => {
                document.getElementById('durationValue').textContent = duration.value + ' hours';
            });

            sensitivity.addEventListener('input', () => {
                document.getElementById('sensitivityValue').textContent = sensitivity.value + '% confidence';
            });
        }

        function bindEventListeners() {
            document.getElementById('planRoute').addEventListener('click', planRoute);
            document.getElementById('startMission').addEventListener('click', startMission);
            document.getElementById('emergencyStop').addEventListener('click', emergencyStop);
            document.getElementById('returnHome').addEventListener('click', returnHome);
            document.getElementById('connectDrone').addEventListener('click', connectRealDrone);
            
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => switchTab(tab.dataset.tab));
            });

            document.getElementById('detectionMode').addEventListener('change', updateDetectionMode);
            
            setupMapControls();
        }

        function startMission() {
            if (missionActive) return;
            
            if (!droneConnected) {
                addAlert('Mission Error', 'No drone connected - cannot start mission', 'warning');
                return;
            }
            
            if (document.getElementById('pattern').value === 'waypoints' && waypoints.length < 2) {
                addAlert('Mission Error', 'Need at least 2 waypoints for custom route', 'warning');
                return;
            }
            
            missionActive = true;
            startTime = Date.now();
            
            document.getElementById('startMission').textContent = 'Mission Active...';
            document.getElementById('startMission').style.background = 'linear-gradient(45deg, #ff6b35, #f7931e)';
            document.getElementById('startMission').disabled = true;
            
            // Update drone status
            document.getElementById('droneAlphaStatus').textContent = 'Active';
            document.getElementById('droneBetaStatus').textContent = 'Active';
            document.getElementById('droneGammaStatus').textContent = 'Active';
            
            addAlert('Mission Started', 'Enhanced conservation mission initiated with real-time wildlife monitoring', 'info');
            clearDetections();
            
            map.setView(dronePosition, 16);
            
            document.getElementById('feedStatus').textContent = 'üé• LIVE MULTI-FEED ACTIVE';
        }

        function returnHome() {
            if (!missionActive) return;
            
            clearMapMarkers();
            
            const homePosition = [-1.5043, 35.1432];
            dronePosition = [...homePosition];
            droneMarker.setLatLng(dronePosition);
            map.setView(dronePosition, 14);
            
            addAlert('Returning Home', 'Drone fleet returning to base station', 'info');
            
            setTimeout(() => {
                if (missionActive) {
                    emergencyStop();
                    addAlert('Mission Complete', 'All drones returned safely - mission data saved', 'info');
                }
            }, 3000);
        }

        function emergencyStop() {
            missionActive = false;
            isRecording = false;
            audioAnalysisMode = false;
            
            document.getElementById('startMission').textContent = 'Start Autonomous Mission';
            document.getElementById('startMission').style.background = 'linear-gradient(45deg, #00ff88, #00ccff)';
            document.getElementById('startMission').disabled = false;
            
            // Update drone status
            document.getElementById('droneAlphaStatus').textContent = 'Standby';
            document.getElementById('droneBetaStatus').textContent = 'Standby';
            document.getElementById('droneGammaStatus').textContent = 'Standby';
            
            const recordBtn = document.getElementById('recordVideo');
            recordBtn.textContent = 'üé¨ Record';
            recordBtn.classList.remove('recording');
            
            const audioBtn = document.getElementById('audioAnalysis');
            audioBtn.style.background = '';
            audioBtn.style.color = 'white';
            document.getElementById('audioPanel').style.display = 'none';
            
            document.getElementById('feedStatus').textContent = 'üé• FEED STANDBY';
            
            addAlert('Emergency Stop', 'All systems terminated - conservation data saved', 'warning');
            generateMissionReport();
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.style.display = 'none');
            
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
            document.getElementById(`${tabName}-content`).style.display = 'block';
        }

        function updateMissionStatus() {
            if (!missionActive) return;
            
            const elapsed = Date.now() - startTime;
            const hours = Math.floor(elapsed / 3600000);
            const minutes = Math.floor((elapsed % 3600000) / 60000);
            const seconds = Math.floor((elapsed % 60000) / 1000);
            
            const speed = parseFloat(document.getElementById('speed').value);
            const distance = (elapsed / 3600000) * speed;
            document.getElementById('areaCovered').textContent = (distance * 0.8).toFixed(1) + ' km¬≤';
        }

        function simulateDetections() {
            if (!missionActive) return;
            
            const mode = document.getElementById('detectionMode').value;
            const sensitivity = parseInt(document.getElementById('sensitivity').value);
            
            const detectionChance = Math.random() * 100;
            
            if (detectionChance < 35) {
                if (mode === 'all' || mode === 'wildlife' || mode === 'species_recognition') {
                    simulateSpeciesDetection(sensitivity);
                }
                
                if (mode === 'all' || mode === 'threats') {
                    if (Math.random() < 0.12) {
                        simulateThreatDetection(sensitivity);
                    }
                }
                
                if (mode === 'all' || mode === 'environment') {
                    simulateEnvironmentalEvent();
                }
                
                if (mode === 'behavior') {
                    simulateBehaviorAnalysis();
                }
            }
        }

        function simulateThreatDetection(sensitivity) {
            const threat = threatTypes[Math.floor(Math.random() * threatTypes.length)];
            const confidence = Math.max(85, Math.random() * 100);
            const location = generateRandomLocation();
            
            if (confidence >= 85) {
                threatCount++;
                document.getElementById('threatCount').textContent = threatCount;
                
                addDetection(threat, 1, confidence, 'threat', location);
                addDetectionMarker(location, 'threat', threat);
                addAlert('Security Threat Detected', `${threat} detected - Automatic response initiated`, 'danger');
                
                setTimeout(() => {
                    takePhoto();
                    if (!isRecording) toggleRecording();
                }, 500);
                
                dispatchEmergencyResponse(threat, location);
            }
        }

        function dispatchEmergencyResponse(threat, location) {
            const responseTeams = [
                'Park Rangers Alpha Team',
                'Anti-Poaching Unit Beta',
                'Local Police Wildlife Division',
                'Wildlife Veterinary Emergency Unit'
            ];
            
            const team = responseTeams[Math.floor(Math.random() * responseTeams.length)];
            addAlert('Emergency Response', `${team} dispatched to ${location[0].toFixed(4)}, ${location[1].toFixed(4)}`, 'info');
        }

        function simulateEnvironmentalEvent() {
            const events = [
                'Deforestation Alert - Satellite imagery analysis',
                'Water Quality Change - Chemical sensors triggered',
                'Habitat Disturbance - Vegetation index anomaly',
                'Climate Pattern Shift - Long-term monitoring alert'
            ];
            
            if (Math.random() < 0.06) {
                const event = events[Math.floor(Math.random() * events.length)];
                const location = generateRandomLocation();
                
                addDetection(event, 1, 94, 'environmental', location);
                addDetectionMarker(location, 'environmental', event);
                addAlert('Environmental Alert', event, 'warning');
            }
        }

        function addDetection(species, count, confidence, type, location) {
            const detectionList = document.getElementById('detectionList');
            const time = new Date().toLocaleTimeString();
            
            const detectionItem = document.createElement('div');
            detectionItem.className = `detection-item ${type}`;
            
            detectionItem.innerHTML = `
                <div class="detection-info">
                    <div class="detection-species">${species} ${count > 1 ? `(${count} individuals)` : ''}</div>
                    <div class="detection-details">
                        ${time} ‚Ä¢ GPS: ${location[0].toFixed(4)}, ${location[1].toFixed(4)} ‚Ä¢ 
                        ${type === 'wildlife' ? 'Wildlife Detection' : type === 'threat' ? 'Security Threat' : 'Environmental Alert'}
                        ${type === 'threat' ? ' ‚Ä¢ Auto-response activated' : ''}
                        ${isOnline ? ' ‚Ä¢ Real-time API verification' : ' ‚Ä¢ Offline detection'}
                    </div>
                </div>
                <div class="confidence-bar">
                    <div class="confidence-fill" style="width: ${confidence}%"></div>
                </div>
            `;
            
            detectionList.insertBefore(detectionItem, detectionList.firstChild);
            
            while (detectionList.children.length > 20) {
                detectionList.removeChild(detectionList.lastChild);
            }
        }

        function generateRandomLocation() {
            const offset = 0.005;
            const lat = dronePosition[0] + (Math.random() - 0.5) * offset;
            const lng = dronePosition[1] + (Math.random() - 0.5) * offset;
            return [lat, lng];
        }

        function addAlert(title, message, type) {
            const alertPanel = document.getElementById('alertPanel');
            const alert = document.createElement('div');
            alert.className = 'alert-item';
            
            const alertId = Date.now();
            alerts.push({ id: alertId, title, message, type, time: new Date() });
            
            let alertColor = '#ff4444';
            if (type === 'info') alertColor = '#00ff88';
            if (type === 'warning') alertColor = '#ffaa00';
            
            alert.style.background = `rgba(${alertColor === '#ff4444' ? '255, 68, 68' : alertColor === '#00ff88' ? '0, 255, 136' : '255, 170, 0'}, 0.9)`;
            alert.style.borderColor = alertColor;
            
            alert.innerHTML = `
                <div class="alert-header">
                    <div class="alert-title">üö® ${title}</div>
                    <div class="alert-time">${new Date().toLocaleTimeString()}</div>
                    <button class="close-alert" onclick="removeAlert(${alertId})">√ó</button>
                </div>
                <div class="alert-details">${message}</div>
            `;
            
            alertPanel.insertBefore(alert, alertPanel.firstChild);
            
            if (type === 'info') {
                setTimeout(() => removeAlert(alertId), 10000);
            }
            
            while (alertPanel.children.length > 5) {
                alertPanel.removeChild(alertPanel.lastChild);
            }
        }

        function removeAlert(alertId) {
            const alertElements = document.querySelectorAll('.alert-item');
            alertElements.forEach(el => {
                if (el.innerHTML.includes(`removeAlert(${alertId})`)) {
                    el.remove();
                }
            });
            alerts = alerts.filter(alert => alert.id !== alertId);
        }

        function clearDetections() {
            const detectionList = document.getElementById('detectionList');
            detectionList.innerHTML = `
                <div class="detection-item">
                    <div class="detection-info">
                        <div class="detection-species">Enhanced AI Systems Active</div>
                        <div class="detection-details">Advanced conservation monitoring operational - Real wildlife APIs connected - Species recognition enhanced</div>
                    </div>
                    <div class="confidence-bar">
                        <div class="confidence-fill" style="width: 100%"></div>
                    </div>
                </div>
            `;
        }

        function updateDetectionMode() {
            const mode = document.getElementById('detectionMode').value;
            let modeDescription = '';
            
            switch (mode) {
                case 'all':
                    modeDescription = 'Comprehensive monitoring: wildlife, threats, environment, and behavioral patterns with real-time API verification';
                    break;
                case 'wildlife':
                    modeDescription = 'Wildlife conservation mode: species identification using iNaturalist, eBird, and African Wildlife databases';
                    break;
                case 'threats':
                    modeDescription = 'Security mode: poaching detection and threat assessment with emergency response coordination';
                    break;
                case 'environment':
                    modeDescription = 'Environmental monitoring: habitat health and climate analysis with satellite data integration';
                    break;
                case 'behavior':
                    modeDescription = 'Behavioral analysis: migration patterns and animal behavior prediction using ML algorithms';
                    break;
                case 'species_recognition':
                    modeDescription = 'Advanced species recognition: conservation status tracking with real-time API cross-referencing';
                    break;
            }
            
            addAlert('Detection Mode Updated', modeDescription, 'info');
        }

        function startEnvironmentalMonitoring() {
            updateEnvironmentalData();
        }

        function updateEnvironmentalData() {
            // Use real weather data if available, otherwise simulate
            if (weatherData && weatherData.current_weather) {
                const temp = weatherData.current_weather.temperature;
                const wind = weatherData.current_weather.windspeed;
                document.getElementById('temperature').textContent = temp.toFixed(1) + '¬∞C';
                document.getElementById('windSpeed').textContent = Math.round(wind);
            } else {
                // Fallback simulation
                const temp = 24.3 + (Math.random() - 0.5) * 3;
                const humidity = 67 + (Math.random() - 0.5) * 15;
                const wind = 12 + (Math.random() - 0.5) * 10;
                
                document.getElementById('temperature').textContent = temp.toFixed(1) + '¬∞C';
                document.getElementById('humidity').textContent = Math.round(humidity) + '%';
                document.getElementById('windSpeed').textContent = Math.round(wind);
            }
        }

        function updateWeatherData() {
            if (dronePosition) {
                getWeatherData(dronePosition[0], dronePosition[1]).then(data => {
                    weatherData = data;
                    updateEnvironmentalData();
                });
            }
        }

        function simulateBehaviorAnalysis() {
            if (!missionActive) return;
            
            const behaviors = [
                'Migration pattern detected - Wildebeest herd moving northwest (confirmed via satellite tracking)',
                'Territorial behavior observed - Lion pride marking boundaries (cross-referenced with eBird data)',
                'Feeding activity increased near water sources (verified through environmental sensors)',
                'Mating calls detected - Elephant breeding season activity (confirmed via audio analysis)',
                'Protective behavior - Adult animals showing vigilance (behavioral pattern recognition)',
                'Nocturnal hunting patterns observed (thermal imaging confirmation)',
                'Social grouping changes detected (AI behavioral analysis)',
                'Seasonal shelter-seeking behavior identified (weather correlation analysis)'
            ];
            
            const behavior = behaviors[Math.floor(Math.random() * behaviors.length)];
            addAlert('Behavioral Pattern', behavior, 'info');
        }

        function generateMissionReport() {
            if (!startTime) return;
            
            const elapsed = Date.now() - startTime;
            const hours = Math.floor(elapsed / 3600000);
            const minutes = Math.floor((elapsed % 3600000) / 60000);
            
            const report = `
                Enhanced Conservation Mission Report:
                Duration: ${hours}h ${minutes}m
                Wildlife Detections: ${detectionCount}
                Security Incidents: ${threatCount}
                Photos: ${photoCount} | Videos: ${videoCount}
                Species Identified: ${document.getElementById('speciesCount').textContent}
                Coverage: ${document.getElementById('areaCovered').textContent}
                API Sources: ${isOnline ? 'iNaturalist, eBird, GBIF, African Wildlife DB' : 'Offline Cache Only'}
                Data Quality: ${isOnline ? 'Real-time verified' : 'Cached data used'}
                Conservation Impact: High-priority species monitored and protected
                Network Status: ${isOnline ? 'Online - Full API access' : 'Offline - Local processing'}
            `;
            
            console.log(report);
            addAlert('Mission Report', 'Comprehensive conservation report generated and ready for transmission', 'info');
        }

        function updateSpeciesCount() {
            const speciesDetected = document.querySelectorAll('.species-card .detection-species');
            const uniqueSpecies = new Set();
            
            speciesDetected.forEach(detection => {
                const text = detection.textContent;
                const species = text.split(' (')[0];
                if (species && species !== 'Enhanced AI Systems Active') {
                    uniqueSpecies.add(species);
                }
            });
            
            document.getElementById('speciesCount').textContent = uniqueSpecies.size;
        }

        function setupVideoControls() {
            document.getElementById('takePhoto').addEventListener('click', takePhoto);
            document.getElementById('recordVideo').addEventListener('click', toggleRecording);
            document.getElementById('toggleThermal').addEventListener('click', toggleThermal);
            document.getElementById('toggleNightVision').addEventListener('click', toggleNightVision);
            document.getElementById('toggleZoom').addEventListener('click', toggleZoom);
            document.getElementById('audioAnalysis').addEventListener('click', toggleAudioAnalysis);
        }

        // Global functions for popup buttons
        window.centerOnDrone = centerOnDrone;
        window.removeWaypoint = removeWaypoint;
        window.removeAlert = removeAlert;
        window.addWaypoint = addWaypoint;
        window.deployDroneHere = deployDroneHere;

        // Initialize the enhanced system
        document.addEventListener('DOMContentLoaded', function() {
            initializeSystem();
            
            setTimeout(() => {
                addAlert('WildGuard AI Enhanced', 'Advanced wildlife conservation system fully operational with real API integration', 'info');
                addAlert('Multi-Drone Support', 'Compatible with MAVLink, DJI, Parrot, Yuneec drones - Offline mode available', 'info');
                addAlert('Wildlife APIs Connected', 'iNaturalist, eBird, GBIF, and African Wildlife databases active', 'info');
            }, 3000);
        });

        // Cleanup old markers for performance
        setInterval(() => {
            const markers = [];
            map.eachLayer(layer => {
                if (layer instanceof L.Marker && layer !== droneMarker) {
                    markers.push(layer);
                }
            });
            
            if (markers.length > 25) {
                markers.slice(0, markers.length - 25).forEach(marker => {
                    map.removeLayer(marker);
                });
            }
        }, 90000);

        // Save species data to local storage periodically
        setInterval(() => {
            if (cachedSpeciesData.size > 0) {
                try {
                    localStorage.setItem('wildlife_cache', JSON.stringify(Array.from(cachedSpeciesData.entries())));
                } catch (error) {
                    console.log('Failed to save species cache:', error);
                }
            }
        }, 60000); // Save every minute

        // Console startup messages
        console.log('üåø WildGuard AI Enhanced Conservation System Loaded');
        console.log('üåç Global wildlife monitoring with location search capability');
        console.log('ü§ñ Real wildlife API integration: iNaturalist, eBird, GBIF, African Wildlife DB');
        console.log('üõ∞Ô∏è Multi-drone support: MAVLink, DJI, Parrot, Yuneec protocols');
        console.log('üì± Offline mode with cached species database and maps');
        console.log('üîÑ Long-range operation with automatic reconnection');
        console.log('üéØ Enhanced location search with global coverage');
    </script>
</body>
</html>